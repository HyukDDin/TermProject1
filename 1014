import os
import re
import pandas as pd
from ast import literal_eval
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HERE = os.path.dirname(__file__)
CANDIDATES = ["movies_details_clean.csv", "movies_details.csv"]

def _read_first_existing():
    for name in CANDIDATES:
        path = os.path.join(HERE, name)
        if os.path.exists(path):
            df = pd.read_csv(path)
            print(f"ğŸ“„ loaded: {path} -> {df.shape}")
            return df, path
    raise FileNotFoundError("movies_details_clean.csv ë˜ëŠ” movies_details.csv íŒŒì¼ì´ í´ë”ì— ì—†ìŠµë‹ˆë‹¤.")

df, LOADED_PATH = _read_first_existing()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ë°ì´í„° ì ê²€ ë° ê¸°ë³¸ í†µê³„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\n[ê¸°ë³¸ ì •ë³´]")
print("í–‰(row), ì—´(column) ìˆ˜:", df.shape)
print("\n[ê¸°ìˆ í†µê³„ ìš”ì•½]")
print(df.describe(include="all").T.head(10))  # ì•ë¶€ë¶„ë§Œ ë³´ê¸° ì¢‹ê²Œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ê²°ì¸¡ì¹˜ ì ê²€ ë° ì²˜ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\n[ê²°ì¸¡ì¹˜ ê°œìˆ˜ í™•ì¸]")
print(df.isnull().sum())

# ê²°ì¸¡ì¹˜ê°€ ì ˆë°˜ ì´ìƒì¸ ì—´ ì œê±°
df.dropna(axis=1, thresh=len(df)*0.5, inplace=True)
print("\nâ¡ 50% ì´ìƒ ê²°ì¸¡ì¹˜ ì—´ ì œê±° í›„:", df.shape)

# ê²°ì¸¡ì¹˜ëŠ” ê³µë°± ë¬¸ìì—´ë¡œ ì±„ìš°ê¸°
fill_cols = ["genres", "keywords", "cast", "director", "overview", "title"]
for col in fill_cols:
    if col in df.columns:
        df[col].fillna("", inplace=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ë¬¸ìì—´ ì •ë¦¬ (strip, lower, upper, replace)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "title" in df.columns:
    # ê³µë°± ì œê±°
    df["title"] = df["title"].astype(str).str.strip()
    # ëª¨ë“  ì œëª©ì„ ì†Œë¬¸ìë¡œ ì €ì¥
    df["title_lower"] = df["title"].str.lower()
    # ëŒ€ë¬¸ì ë²„ì „ë„ ì°¸ê³ ìš©ìœ¼ë¡œ ì¶”ê°€
    df["title_upper"] = df["title"].str.upper()
    # ë¶ˆí•„ìš”í•œ íŠ¹ìˆ˜ë¬¸ì ì˜ˆì‹œ ì¹˜í™˜
    df["title"] = df["title"].replace(r"[^0-9A-Za-zê°€-í£\s]", "", regex=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ë¦¬ìŠ¤íŠ¸í˜• ë°ì´í„° ì •ê·œí™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def to_list(x):
    if isinstance(x, list):
        return x
    s = str(x).strip()
    if not s:
        return []
    if s.startswith("[") and s.endswith("]"):
        try:
            val = literal_eval(s)
            if isinstance(val, list):
                return [str(t) for t in val]
        except:
            pass
    return [t.strip() for t in re.split(r"[,/|]", s) if t.strip()]

for col in ["genres", "keywords", "cast"]:
    if col in df.columns:
        df[col] = df[col].apply(to_list)

if "director" in df.columns:
    df["director"] = df["director"].astype(str).str.strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) í†µí•© í…ìŠ¤íŠ¸ ì»¬ëŸ¼ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df["combined_features"] = (
    df.get("genres", "").apply(" ".join) + " " +
    df.get("keywords", "").apply(" ".join) + " " +
    df.get("director", "") + " " +
    df.get("cast", "").apply(" ".join) + " " +
    df.get("overview", "").astype(str)
).str.strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) TF-IDF + ì½”ì‚¬ì¸ ìœ ì‚¬ë„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vectorizer = TfidfVectorizer(stop_words=None, min_df=1, ngram_range=(1, 2))
tfidf = vectorizer.fit_transform(df["combined_features"])
cosine_sim = cosine_similarity(tfidf, tfidf)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ê¸°ë³¸ í†µê³„ (mean, max, min, sort_values)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "vote_average" in df.columns:
    print("\n[í‰ì  í†µê³„]")
    print(f"í‰ê· : {df['vote_average'].mean():.2f}")
    print(f"ìµœê³ : {df['vote_average'].max():.2f}")
    print(f"ìµœì €: {df['vote_average'].min():.2f}")

    # í‰ì  ë†’ì€ ìƒìœ„ 5ê°œ
    print("\n[í‰ì  ìƒìœ„ 5ê°œ ì˜í™”]")
    print(df.sort_values(by="vote_average", ascending=False)[["title", "vote_average"]].head(5))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8) ê²€ìƒ‰ / ì¶”ì²œ í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def search_titles(q, top=20):
    q = str(q).strip().lower()
    hits = df[df["title_lower"].str.contains(re.escape(q), na=False)]["title"].dropna().unique().tolist()
    return hits[:top]

def _find_idx(title):
    q = str(title).strip().lower()
    exact = df.index[df["title_lower"] == q]
    if len(exact):
        return int(exact[0])
    partial = df.index[df["title_lower"].str.contains(re.escape(q), na=False)]
    if len(partial):
        return int(partial[0])
    return None

def recommend_by_content(title, top_n=10, include_scores=False):
    idx = _find_idx(title)
    if idx is None:
        examples = search_titles("", 10)
        return f"âŒ ì œëª©ì„ ëª» ì°¾ì•˜ì–´ìš”: {title}\n   ì˜ˆì‹œ: {examples}"
    sims = list(enumerate(cosine_sim[idx]))
    sims = sorted(sims, key=lambda x: x[1], reverse=True)
    sims = [s for s in sims if s[0] != idx][:top_n]
    rec_idx = [i for i, _ in sims]
    cols = [c for c in ["title", "genres", "vote_average", "release_date"] if c in df.columns]
    out = df.iloc[rec_idx][cols].reset_index(drop=True).copy()
    if include_scores:
        out["similarity"] = [score for _, score in sims]
    return out.sort_values(by="vote_average", ascending=False)  # í‰ì ìˆœ ì •ë ¬

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9) ë‹¨ë… ì‹¤í–‰ í…ŒìŠ¤íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    print("\nìƒ˜í”Œ 10ê°œ ì œëª©:", df["title"].dropna().head(10).tolist())
    print("ê²€ìƒ‰ ì˜ˆì‹œ('íŒíƒ€ìŠ¤í‹±'):", search_titles("íŒíƒ€ìŠ¤í‹±"))
    print("ê²€ìƒ‰ ì˜ˆì‹œ('ê·€ë©¸'):", search_titles("ê·€ë©¸"))
    print("ê²€ìƒ‰ ì˜ˆì‹œ('ìš°ì£¼ì „ìŸ'):", search_titles("ìš°ì£¼ì „ìŸ"))

    def show(x, title):
        print(f"\n[ì¶”ì²œ ì˜ˆì‹œ] '{title}' ê¸°ì¤€")
        if hasattr(x, "to_string"):
            print(x.to_string(index=False))
        else:
            print(x)

    show(recommend_by_content("íŒíƒ€ìŠ¤í‹±", 5, include_scores=True), "íŒíƒ€ìŠ¤í‹±")
    show(recommend_by_content("ê·€ë©¸", 5, include_scores=True), "ê·€ë©¸")
    show(recommend_by_content("ìš°ì£¼ì „ìŸ", 5, include_scores=True), "ìš°ì£¼ì „ìŸ")
