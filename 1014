# content_recommender.py
import os
import re
import pandas as pd
from ast import literal_eval
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) ë°ì´í„° ë¡œë“œ (clean ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì‚¬ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HERE = os.path.dirname(__file__)
CANDIDATES = ["movies_details_clean.csv", "movies_details.csv"]

def _read_first_existing():
    for name in CANDIDATES:
        path = os.path.join(HERE, name)
        if os.path.exists(path):
            df = pd.read_csv(path)
            print(f"ğŸ“„ loaded: {path} -> {df.shape}")
            return df, path
    raise FileNotFoundError("movies_details_clean.csv ë˜ëŠ” movies_details.csv íŒŒì¼ì´ í´ë”ì— ì—†ìŠµë‹ˆë‹¤.")

df, LOADED_PATH = _read_first_existing()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ì „ì²˜ë¦¬ ìœ í‹¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def to_list(x):
    """ë¬¸ìì—´ë¡œ ì €ì¥ëœ ë¦¬ìŠ¤íŠ¸/êµ¬ë¶„ì ë°ì´í„°ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜"""
    if isinstance(x, list):
        return x
    s = str(x).strip()
    if not s:
        return []
    if s.startswith("[") and s.endswith("]"):
        try:
            val = literal_eval(s)
            if isinstance(val, list):
                return [str(t) for t in val]
        except:
            pass
    # ì½¤ë§ˆ/ìŠ¬ë˜ì‹œ/íŒŒì´í”„ë¡œ êµ¬ë¶„ëœ ê²½ìš°
    return [t.strip() for t in re.split(r"[,/|]", s) if t.strip()]

# ê²°ì¸¡ì¹˜ ì±„ìš°ê¸°
for col in ["genres", "keywords", "cast", "director", "overview", "title"]:
    if col in df.columns:
        df[col] = df[col].fillna("")

# ë¦¬ìŠ¤íŠ¸í˜•ìœ¼ë¡œ ì •ê·œí™”
df["genres"]   = df.get("genres", "").apply(to_list)
df["keywords"] = df.get("keywords", "").apply(to_list)
df["cast"]     = df.get("cast", "").apply(to_list)
df["director"] = df.get("director", "").astype(str)

# ì¶”ì²œìš© í†µí•© í…ìŠ¤íŠ¸
df["combined_features"] = (
    df["genres"].apply(" ".join) + " " +
    df["keywords"].apply(" ".join) + " " +
    df["director"] + " " +
    df["cast"].apply(" ".join) + " " +
    df.get("overview", "").astype(str)
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) TF-IDF & ì½”ì‚¬ì¸ ìœ ì‚¬ë„
#   - í•œêµ­ì–´ê°€ ë§ìœ¼ë‹ˆ stop_words=None ê¶Œì¥
#   - ì‘ì€ ë°ì´í„°ì…‹ì´ë¼ min_df=1
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vectorizer = TfidfVectorizer(stop_words=None, min_df=1, ngram_range=(1, 2))
tfidf = vectorizer.fit_transform(df["combined_features"])
cosine_sim = cosine_similarity(tfidf, tfidf)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ê²€ìƒ‰/ì¶”ì²œ í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def search_titles(q, top=20):
    """ë¶€ë¶„ ì¼ì¹˜ë¡œ ì œëª© ê²€ìƒ‰"""
    q = str(q).strip().lower()
    hits = df[df["title"].astype(str).str.lower().str.contains(re.escape(q), na=False)]["title"] \
           .dropna().unique().tolist()
    return hits[:top]

def _find_idx(title):
    """ì œëª© ì™„ì „/ë¶€ë¶„ ì¼ì¹˜ë¡œ ì¸ë±ìŠ¤ ì°¾ê¸°"""
    q = str(title).strip().lower()
    exact = df.index[df["title"].astype(str).str.lower() == q]
    if len(exact):
        return int(exact[0])
    partial = df.index[df["title"].astype(str).str.lower().str.contains(re.escape(q), na=False)]
    if len(partial):
        return int(partial[0])
    return None

def recommend_by_content(title, top_n=10, include_scores=False):
    """ì œëª© í•˜ë‚˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹„ìŠ·í•œ ì˜í™” Top-N ì¶”ì²œ"""
    idx = _find_idx(title)
    if idx is None:
        examples = search_titles("", 10)
        return f"âŒ ì œëª©ì„ ëª» ì°¾ì•˜ì–´ìš”: {title}\n   ì˜ˆì‹œ: {examples}"
    sims = list(enumerate(cosine_sim[idx]))
    sims = sorted(sims, key=lambda x: x[1], reverse=True)
    sims = [s for s in sims if s[0] != idx][:top_n]   # ìê¸° ìì‹  ì œì™¸
    rec_idx = [i for i, _ in sims]
    cols = [c for c in ["title", "genres", "vote_average", "release_date"] if c in df.columns]
    out = df.iloc[rec_idx][cols].reset_index(drop=True).copy()
    if include_scores:
        out["similarity"] = [score for _, score in sims]
    return out

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ë‹¨ë… ì‹¤í–‰ í…ŒìŠ¤íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # ìƒ˜í”Œ / ê²€ìƒ‰ ì²´í¬
    print("\nìƒ˜í”Œ 10ê°œ ì œëª©:", df["title"].dropna().head(10).tolist())
    print("ê²€ìƒ‰ ì˜ˆì‹œ('íŒíƒ€ìŠ¤í‹±'):", search_titles("íŒíƒ€ìŠ¤í‹±"))
    print("ê²€ìƒ‰ ì˜ˆì‹œ('ê·€ë©¸'):", search_titles("ê·€ë©¸"))
    print("ê²€ìƒ‰ ì˜ˆì‹œ('ìš°ì£¼ì „ìŸ'):", search_titles("ìš°ì£¼ì „ìŸ"))

    # ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥í•˜ëŠ” í—¬í¼
    def show(x, title):
        print(f"\n[ì¶”ì²œ ì˜ˆì‹œ] '{title}' ê¸°ì¤€")
        if hasattr(x, "to_string"):
            print(x.to_string(index=False))   # í‘œë¥¼ ê°•ì œë¡œ ì „ì²´ ë¬¸ìì—´ë¡œ ì¶œë ¥
        else:
            print(x)

    # ë°ì´í„°ì…‹ì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì œëª©ìœ¼ë¡œ í˜¸ì¶œ
    show(recommend_by_content("íŒíƒ€ìŠ¤í‹±", 5, include_scores=True), "íŒíƒ€ìŠ¤í‹±")
    show(recommend_by_content("ê·€ë©¸", 5, include_scores=True), "ê·€ë©¸")
    show(recommend_by_content("ìš°ì£¼ì „ìŸ", 5, include_scores=True), "ìš°ì£¼ì „ìŸ")

