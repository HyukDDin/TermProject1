# ============================================================
# [ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ] â€” ì˜¤ëŠ˜ ì‘ì—… ëª¨ìŒ (ì£¼ì„ ë²„ì „)
#  - ê²€ìƒ‰ì–´ ë¡œê·¸ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
#  - ê²€ìƒ‰ì–´ ê¸°ë¡/ì¡°íšŒ/ì‚­ì œ ìœ í‹¸
#  - TF-IDF ê³µê°„ì—ì„œ ê²€ìƒ‰ì–´â†’ì˜í™” ìœ ì‚¬ë„ ëˆ„ì  ì¶”ì²œ
#  - UI: ë²„íŠ¼, ìµœê·¼ê²€ìƒ‰ í‘œì‹œ, ì¹´ë“œ ê·¸ë¦¬ë“œ ë Œë”
#  - (ì „ì œ) vec, X, df ëŠ” ì•± ìƒë‹¨ì—ì„œ ì´ë¯¸ êµ¬ì¶•ë¨ (TF-IDF, ì½”í¼ìŠ¤, ë°ì´í„°í”„ë ˆì„)
# ============================================================

# -------- 0) DB ì—°ê²° í—¬í¼ -------------------------------------------------------
DB_PATH = "users.db"

def _conn():
    """SQLite ì—°ê²° í•¸ë“¤ëŸ¬(ìŠ¤ë ˆë“œ ì•ˆì „ ì˜µì…˜ í¬í•¨)."""
    import sqlite3
    return sqlite3.connect(DB_PATH, check_same_thread=False)


# -------- 1) init_db() ë‚´ì— ì¶”ê°€/í™•ì¸í•œ 'ê²€ìƒ‰ ë¡œê·¸' í…Œì´ë¸” -------------------------
def init_db():
    """
    ì•± ì‹œì‘ ì‹œ í•œ ë²ˆ í˜¸ì¶œ.
    ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ í…Œì´ë¸” ìƒì„±.
    """
    con = _conn(); cur = con.cursor()

    # (ê¸°ì¡´ users / user_ratings / user_favorites ìƒì„±ë¶€ ìƒëµ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    # âœ… ì‚¬ìš©ì ê²€ìƒ‰ ë¡œê·¸ í…Œì´ë¸”
    cur.execute("""
    CREATE TABLE IF NOT EXISTS user_searches (
        id INTEGER PRIMARY KEY AUTOINCREMENT,  -- ê°œë³„ ë¡œê·¸ id
        user_id INTEGER,                       -- ëˆ„ê°€ ê²€ìƒ‰í–ˆëŠ”ì§€(ë¡œê·¸ì¸ ì•ˆë¼ë„ None í—ˆìš© ê°€ëŠ¥)
        query   TEXT NOT NULL,                 -- ê²€ìƒ‰ì–´ ìì²´(ì œëª© ì„ íƒ/íŒíŠ¸ ë“±)
        searched_at TEXT                       -- UTC ISO8601 íƒ€ì„ìŠ¤íƒ¬í”„
    )
    """)
    # ì¡°íšŒ ì†ë„ ê°œì„ ì„ ìœ„í•œ ë³´ì¡° ì¸ë±ìŠ¤(ì‚¬ìš©ìë³„ ìµœì‹ ìˆœ)
    cur.execute("""
    CREATE INDEX IF NOT EXISTS idx_user_searches_user
    ON user_searches(user_id, searched_at DESC)
    """)

    con.commit(); con.close()


# -------- 2) ê²€ìƒ‰ ë¡œê·¸ ìœ í‹¸ í•¨ìˆ˜ 3ì¢… --------------------------------------------
from datetime import datetime

def log_search(user_id: int | None, query: str):
    """
    [ì“°ê¸°] ê²€ìƒ‰/ì„ íƒ ì´ë²¤íŠ¸ë¥¼ í•œ ì¤„ì”© ë‚¨ê¸´ë‹¤.
    - user_id: ë¡œê·¸ì¸ ì‚¬ìš©ì id (ì—†ìœ¼ë©´ None ê°€ëŠ¥)
    - query  : ì‚¬ìš©ìê°€ ì…ë ¥/ì„ íƒí•œ ê²€ìƒ‰ ë¬¸ìì—´
    """
    q = (query or "").strip()
    if not q:
        return  # ë¹ˆ ë¬¸ìì—´ì€ ë¡œê¹…í•˜ì§€ ì•ŠìŒ
    con = _conn(); cur = con.cursor()
    cur.execute(
        "INSERT INTO user_searches (user_id, query, searched_at) VALUES (?,?,?)",
        (user_id, q, datetime.utcnow().isoformat())
    )
    con.commit(); con.close()

def get_recent_searches(user_id: int, limit: int = 20) -> list[str]:
    """
    [ì½ê¸°] ìµœê·¼ ê²€ìƒ‰ì–´ë¥¼ ìµœì‹ ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤.
    - limit: ê°€ì ¸ì˜¬ ê°œìˆ˜ (ê¸°ë³¸ 20)
    """
    con = _conn(); cur = con.cursor()
    cur.execute(
        "SELECT query FROM user_searches WHERE user_id=? ORDER BY searched_at DESC LIMIT ?",
        (user_id, limit)
    )
    rows = [r[0] for r in cur.fetchall()]
    con.close()
    return rows

def clear_searches(user_id: int):
    """[ì‚­ì œ] ë‚´ ê²€ìƒ‰ ê¸°ë¡ ì „ì²´ ì‚­ì œ."""
    con = _conn(); cur = con.cursor()
    cur.execute("DELETE FROM user_searches WHERE user_id=?", (user_id,))
    con.commit(); con.close()


# -------- 3) (ì „ì œ) ì¶”ì²œì— í•„ìš”í•œ ì „ì—­(ì´ë¯¸ ì•± ìƒë‹¨ì—ì„œ ì¤€ë¹„ë¨) -------------------
# vec: TfidfVectorizer.fit(corpus) ê²°ê³¼
# X  : ë¬¸ì„œ-ë‹¨ì–´ TF-IDF í–‰ë ¬ (ëª¨ë“  ì˜í™”)
# df : ì˜í™” DataFrame (id, title, genres, vote_average, poster_path ...)

# ì˜ˆì‹œ)
# vec = TfidfVectorizer(...).fit(corpus) ; X = vec.transform(corpus)
# cosine_sim = cosine_similarity(X, X)


# -------- 4) ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ ë³¸ì²´ --------------------------------------------
import numpy as np
import pandas as pd

def recommend_from_search_history(user_id: int, top_k: int = 24) -> pd.DataFrame:
    """
    [í•µì‹¬ ì•Œê³ ë¦¬ì¦˜]
    1) ì‚¬ìš©ì ìµœê·¼ ê²€ìƒ‰ì–´ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    2) ê° ê²€ìƒ‰ì–´ë¥¼ TF-IDF ë²¡í„°ë¡œ ë³€í™˜ â†’ ì „ì²´ ì˜í™” ì½”í¼ìŠ¤(X)ì™€ ì ê³±ìœ¼ë¡œ ìœ ì‚¬ë„ ê³„ì‚°
       (qv @ X.T)  : 'ê²€ìƒ‰ì–´' vs 'ì˜í™”ë¬¸ì„œ' ì½”ì‚¬ì¸ ìœ ì‚¬ë„(ì •ê·œí™”ëœ TFIDFë¼ë©´ ì ê³±ì´ ìœ ì‚¬ë„ì— í•´ë‹¹)
    3) 'ìµœê·¼ì¼ìˆ˜ë¡' ë” í° ê°€ì¤‘ì¹˜(ì§€ìˆ˜ê°ì‡ )ë¡œ ëˆ„ì  í•©ì‚° â†’ ìµœì¢… ì ìˆ˜ ë²¡í„°
    4) ë‚´ê°€ ì´ë¯¸ í‰ì  ë‚¨ê²¼ê±°ë‚˜ ì¦ê²¨ì°¾ê¸°í•œ ì˜í™”ëŠ” ì œì™¸
    5) ìƒìœ„ top_kí¸ì„ DataFrameìœ¼ë¡œ ë°˜í™˜
    6) ì‹œê°í™” í¸ì˜ë¥¼ ìœ„í•´ ì ìˆ˜ 0~1ë¡œ ì •ê·œí™” ì»¬ëŸ¼(search_score) ì¶”ê°€
    """
    # 3-1) ìµœê·¼ ê²€ìƒ‰ì–´ ìˆ˜ì§‘
    queries = get_recent_searches(user_id, limit=20)
    if not queries:
        return pd.DataFrame()

    # 3-2) ìµœê·¼ ê°€ì¤‘ì¹˜(ì§€ìˆ˜ê°ì‡ ): ê°€ì¥ ìµœê·¼ = 1.0, í•œ ìŠ¤í… ë©€ì–´ì§ˆìˆ˜ë¡ 0.85ë°°
    weights, base, decay = [], 1.0, 0.85
    for i in range(len(queries)):
        weights.append(base * (decay ** i))

    # 3-3) ê²€ìƒ‰ì–´ ìœ ì‚¬ë„ ëˆ„ì  ìŠ¤ì½”ì–´
    scores = np.zeros(X.shape[0], dtype=float)
    for q, w in zip(queries, weights):
        try:
            qv = vec.transform([q])          # ê²€ìƒ‰ì–´ â†’ TF-IDF ë²¡í„°
            sim_q = (qv @ X.T).toarray().ravel()  # ê° ì˜í™”ì™€ì˜ ìœ ì‚¬ë„(ë²¡í„° ì ê³±)
            scores += sim_q * float(w)       # ê°€ì¤‘ í•©ì‚°
        except Exception:
            # ë³€í™˜ ë¶ˆê°€(ì´ìƒ ë¬¸ìì—´ ë“±) ì‹œ í•´ë‹¹ ê²€ìƒ‰ì–´ëŠ” ê±´ë„ˆëœ€
            continue

    # 3-4) ì´ë¯¸ ë³¸ ê²ƒ(í‰ì /ì¦ê²¨ì°¾ê¸°)ì€ ì¶”ì²œ ì œì™¸
    seen = set(mid for mid, _ in get_ratings_by_user(user_id)) | get_favorites(user_id)
    ids = df["id"].fillna(-1).astype(int).tolist() if "id" in df.columns else [-1] * len(df)

    # 3-5) ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ top_kê°œ ë½‘ê¸°
    order = np.argsort(-scores)
    keep_idx = []
    for i in order:
        if ids[i] not in seen:            # ì´ë¯¸ ë³¸ ê²ƒ ì œì™¸
            keep_idx.append(i)
        if len(keep_idx) >= top_k:
            break
    if not keep_idx:
        return pd.DataFrame()

    # 3-6) ê²°ê³¼ í‘œ ìƒì„±(í•„ìš” ì¹¼ëŸ¼ë§Œ)
    cols = ["id","title","genres","vote_average","release_date","poster_path","overview"]
    out = df.iloc[keep_idx][cols].copy().reset_index(drop=True)

    # 3-7) í‘œì‹œìš© ê°€ê³µ(ì¥ë¥´ ë¬¸ìì—´Â·í¬ìŠ¤í„° URLÂ·í‰ì  ë°˜ì˜¬ë¦¼Â·ê²€ìƒ‰ì ìˆ˜ ì •ê·œí™”)
    if "genres" in out.columns:
        out["genres"] = out["genres"].apply(lambda xs: ", ".join(xs) if isinstance(xs, list) else str(xs))
    if "poster_path" in out.columns:
        base_img = "https://image.tmdb.org/t/p/w342"  # ê²€ìƒ‰ ì¶”ì²œì€ ì¡°ê¸ˆ í° ì¸ë„¤ì¼
        out["poster_url"] = out["poster_path"].apply(lambda p: base_img + p if isinstance(p, str) and p else None)
    if "vote_average" in out.columns:
        out["vote_average"] = pd.to_numeric(out["vote_average"], errors="coerce").round(1)

    # 0~1 ì •ê·œí™” ì ìˆ˜(ì‹œê°í™”ìš©)
    raw = np.array([scores[i] for i in keep_idx], dtype=float)
    norm = (raw - raw.min()) / (raw.max() - raw.min()) if raw.max() > raw.min() else np.zeros_like(raw)
    out["search_score"] = np.round(norm, 3)

    return out


# -------- 5) ì¹´ë“œ ê·¸ë¦¬ë“œ(UI) â€” ê²€ìƒ‰ê²°ê³¼ë¥¼ ë³´ê¸° ì¢‹ê²Œ ë Œë” ---------------------------
import streamlit as st

# (ì„ íƒ) ì„¹ì…˜/ì¹´ë“œìš© CSS â€” ì œëª© ë§ì¤„ì„, ë©”íƒ€ ê¸€ì”¨ í¬ê¸° ë“±
st.markdown("""
<style>
.card-caption { text-align:center; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.card-meta    { text-align:center; font-size:0.85rem; opacity:.85; }
.section-title{ font-size:2rem; font-weight:900; margin:.75rem 0 .5rem; display:flex; gap:.5rem; align-items:center; }
</style>
""", unsafe_allow_html=True)

def render_card_grid(items_df: pd.DataFrame, key_prefix: str, *, n_cols: int = 6, score_col: str | None = None):
    """
    ê°„ê²°í•œ ì¹´ë“œ ê·¸ë¦¬ë“œ(ì¸ë„¤ì¼, ì œëª© 1ì¤„, ë©”íƒ€ 1ì¤„, ìƒì„¸ë³´ê¸° ë²„íŠ¼).
    - score_col: 'search_score' ê°™ì€ ì •ê·œí™” ìŠ¤ì½”ì–´ ì»¬ëŸ¼ëª…ì´ë©´ í•¨ê»˜ í‘œì‹œ.
    """
    if items_df is None or items_df.empty:
        st.info("í‘œì‹œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    cols = st.columns(n_cols)
    ph = "https://via.placeholder.com/342x513?text=No+Image"

    for i, row in items_df.reset_index(drop=True).iterrows():
        with cols[i % n_cols]:
            st.image(row.get("poster_url") or ph, use_container_width=True)
            st.markdown(f'<div class="card-caption">{row.get("title","")}</div>', unsafe_allow_html=True)

            vote_txt = f'â­ {float(row["vote_average"]):.1f}' if pd.notna(row.get("vote_average")) else "â­ -"
            score_txt = f' | ì ìˆ˜ {float(row[score_col]):.3f}' if score_col and pd.notna(row.get(score_col)) else ""
            st.markdown(f'<div class="card-meta">{vote_txt}{score_txt}</div>', unsafe_allow_html=True)

            if st.button("ìƒì„¸ë³´ê¸°", key=f"{key_prefix}_detail_{i}"):
                # ìƒì„¸ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ë°ì´í„° ì—°ê²°
                st.session_state["result"] = items_df
                st.session_state["open_modal"] = True
                st.session_state["detail_idx"] = i
                st.rerun()


# -------- 6) ì¶”ì²œ í˜ì´ì§€ì— ë¶™ì´ëŠ” UI ì¡°ê° -----------------------------------------
def render_recommend_section_for_search_history():
    """
    ì¶”ì²œ í˜ì´ì§€(render_recommend_page) ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì„¹ì…˜.
    - 'ë‚´ ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ' ë²„íŠ¼
    - 'ê²€ìƒ‰ê¸°ë¡ ì§€ìš°ê¸°' ë²„íŠ¼
    - 'ìµœê·¼ ê²€ìƒ‰ì–´' ë¯¸ë‹ˆ í‘œì‹œ
    - ê²°ê³¼ëŠ” ìœ„ì˜ render_card_grid()ë¡œ 4~6ì—´ ì¹´ë“œë¡œ ì¶œë ¥
    """
    st.markdown("---")
    colA, colB, colC = st.columns([1,1,2])

    user = st.session_state.get("auth_user")
    user_id = user["id"] if user else None

    with colA:
        if user_id is not None and st.button("ğŸ” ë‚´ ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ"):
            rs = recommend_from_search_history(user_id, top_k=24)  # ë„‰ë„‰íˆ ë½‘ì•„ì„œ
            if rs.empty:
                st.info("ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ê±°ë‚˜ ì¶”ì²œì„ ë§Œë“¤ ìˆ˜ ì—†ì–´ìš”. ë¨¼ì € ëª‡ ë²ˆ ê²€ìƒ‰/ì„ íƒì„ í•´ë³´ì„¸ìš”!")
            else:
                st.markdown("### ğŸ” ë‚´ ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ")
                render_card_grid(rs, key_prefix="searchrec", n_cols=4, score_col="search_score")

    with colB:
        if user_id is not None and st.button("ğŸ—‘ï¸ ê²€ìƒ‰ê¸°ë¡ ì§€ìš°ê¸°"):
            clear_searches(user_id)
            st.success("ê²€ìƒ‰ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.")

    with colC:
        if user_id is not None:
            recent = get_recent_searches(user_id, limit=10)
            if recent:
                st.caption("ìµœê·¼ ê²€ìƒ‰ì–´: " + " Â· ".join(recent))


# -------- 7) (ì¤‘ìš”) 'ì¶”ì²œ ë³´ê¸°' ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ê²€ìƒ‰ì–´ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ê¸° ---------------
#  - render_recommend_page()ì˜ 'ì¶”ì²œ ë³´ê¸°' ì²˜ë¦¬ ì§ì „ì— ì•„ë˜ ì½”ë“œ ì¡°ê°ì„ ë„£ëŠ”ë‹¤.
#  - selected_title: selectboxë¡œ ê³ ë¥¸ ì˜í™” ì œëª©
#  - hint          : í…ìŠ¤íŠ¸ ì…ë ¥(ë¶€ë¶„ ê²€ìƒ‰ì–´)

def _log_queries_when_click_recommend(selected_title: str | None, hint: str | None):
    """
    'ì¶”ì²œ ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œí•´ ê²€ìƒ‰ì–´/ì„ íƒì–´ë¥¼ ë¡œê·¸ì— ì €ì¥.
    """
    user = st.session_state.get("auth_user")
    user_id = user["id"] if user else None
    if user_id is None:
        return

    if selected_title:
        log_search(user_id, selected_title)
    if hint:
        log_search(user_id, hint)

# (ì‚¬ìš© ì˜ˆì‹œ)
# if st.button("ì¶”ì²œ ë³´ê¸°"):
#     _log_queries_when_click_recommend(selected_title, hint)
#     ... (ì´í›„ ê¸°ì¡´ ì¶”ì²œ ë¡œì§ ì‹¤í–‰)
