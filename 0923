import pandas as pd
import requests
import time
import re

# --- 1ë¶€: APIì—ì„œ 'ì˜ì–´'ì™€ 'í•œê¸€' ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ---
API_KEY = "173b049b49a48893e151ad9e2c4968df" # ë³¸ì¸ì˜ API í‚¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
BASE_URL = "https://api.themoviedb.org/3"

def fetch_popular_movies(language):
    """ì§€ì •ëœ ì–¸ì–´ë¡œ ì¸ê¸° ì˜í™” 20 í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜"""
    all_movies = []
    print(f"TMDBì—ì„œ ì¸ê¸° ì˜í™” 20 í˜ì´ì§€ë¥¼ '{language}'ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤...")
    for page in range(1, 21):
        url = f"{BASE_URL}/movie/popular?api_key={API_KEY}&language={language}&page={page}"
        response = requests.get(url)
        if response.status_code == 200:
            movies = response.json().get("results", [])
            all_movies.extend(movies)
            time.sleep(0.3)
        else:
            break
    print(f"âœ… {len(all_movies)}í¸ì˜ '{language}' ì˜í™” ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
    return pd.DataFrame(all_movies)

# ì˜ì–´íŒê³¼ í•œê¸€íŒ ë°ì´í„°ë¥¼ ê°ê° ê°€ì ¸ì˜µë‹ˆë‹¤.
en_movies_df = fetch_popular_movies('en-US')
ko_movies_df = fetch_popular_movies('ko-KR')

# 'id'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‘ ë°ì´í„°ë¥¼ í•©ì³, ì˜ì–´/í•œê¸€ ì œëª©ì„ ëª¨ë‘ ê°€ì§„ ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ë§Œë“­ë‹ˆë‹¤.
# í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒí•´ì„œ í•©ì¹©ë‹ˆë‹¤.
tmdb_master_df = pd.merge(
    en_movies_df[['id', 'title', 'vote_average', 'vote_count']],
    ko_movies_df[['id', 'title']],
    on='id',
    suffixes=('_en', '_ko') # ì»¬ëŸ¼ ì´ë¦„ ë’¤ì— _en, _koë¥¼ ë¶™ì—¬ êµ¬ë¶„
)


# --- 2ë¶€: ë°ì´í„° í•©ì¹˜ê³  ëª¨ë¸ ì‹¤í–‰í•˜ê¸° ---

# ê¸°ì¡´ ì‚¬ìš©ì í‰ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
ratings_df = pd.read_csv('data/ratings.csv')
movies_meta_df = pd.read_csv('data/movies.csv')
movie_ratings_df = pd.merge(ratings_df, movies_meta_df, on='movieId')

# ë°ì´í„° ë³‘í•©ì„ ìœ„í•´ ì œëª©ì„ ê¹¨ë—í•˜ê²Œ ì •ì œí•©ë‹ˆë‹¤.
movie_ratings_df['title_clean'] = movie_ratings_df['title'].str.replace(r'\s*\(\d{4}\)$', '', regex=True).str.lower().str.strip()
tmdb_master_df['title_clean'] = tmdb_master_df['title_en'].str.lower().str.strip()

# ê¹¨ë—í•´ì§„ ì˜ì–´ ì œëª©('title_clean')ì„ ê¸°ì¤€ìœ¼ë¡œ ìµœì¢… ë³‘í•©í•©ë‹ˆë‹¤.
final_df = pd.merge(movie_ratings_df, tmdb_master_df, on='title_clean')
print(f"\nâœ… ë°ì´í„° ë³‘í•© ì„±ê³µ! {len(final_df['title'].unique())}í¸ì˜ ê³µí†µ ì˜í™”ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.")


# --- 3ë¶€: ëª¨ë¸ ì‹¤í–‰ ë° ê²°ê³¼ ì¶œë ¥ ---

C = final_df['vote_average'].mean()
m = final_df['vote_count'].quantile(0.70)

def weighted_rating(x, m=m, C=C):
    v = x['vote_count']
    R = x['vote_average']
    return (v / (v + m) * R) + (m / (v + m) * C)

final_df['weighted_rating'] = final_df.apply(weighted_rating, axis=1)

recommendations = final_df.sort_values('weighted_rating', ascending=False)
recommendations = recommendations.drop_duplicates(subset='title_ko') # í•œê¸€ ì œëª© ê¸°ì¤€ ì¤‘ë³µ ì œê±°

# ì»¬ëŸ¼ ì´ë¦„ì„ ë°”ê¾¸ê³  í‰ì  í˜•ì‹ì„ ì§€ì •í•©ë‹ˆë‹¤.
recommendations.rename(columns={
    'title_ko': 'ì˜í™” ì œëª©',
    'vote_average': 'TMDB í‰ì ',
    'vote_count': 'í‰ê°€ ìˆ˜',
    'weighted_rating': 'ê°€ì¤‘ í‰ì '
}, inplace=True)
recommendations['TMDB í‰ì '] = recommendations['TMDB í‰ì '].apply(lambda score: f"{score:.2f} / 10")


print("\nğŸ† ìµœì¢… ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ (í•œê¸€ ì œëª© Ver.)")
display(recommendations[['ì˜í™” ì œëª©', 'TMDB í‰ì ', 'í‰ê°€ ìˆ˜', 'ê°€ì¤‘ í‰ì ']].head(10))
