# ğŸ“Œ ê²€ìƒ‰ì–´ ì €ì¥
def log_search(user_id, query):
    """ì‚¬ìš©ìê°€ ê²€ìƒ‰í•œ í‚¤ì›Œë“œë¥¼ DBì— ê¸°ë¡"""
    q = query.strip()
    if not q: return
    con=_conn(); cur=con.cursor()
    cur.execute(
        "INSERT INTO user_searches (user_id, query, searched_at) VALUES (?,?,?)",
        (user_id, q, datetime.utcnow().isoformat())
    )
    con.commit(); con.close()

# ğŸ“Œ ìµœê·¼ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
def get_recent_searches(user_id, limit=20):
    """ìµœê·¼ ê²€ìƒ‰ì–´ nê°œ ê°€ì ¸ì˜¤ê¸°(ìµœì‹ ìˆœ)"""
    con=_conn(); cur=con.cursor()
    cur.execute("""
        SELECT query FROM user_searches
        WHERE user_id=? ORDER BY searched_at DESC LIMIT ?
    """,(user_id,limit))
    rows = [r[0] for r in cur.fetchall()]
    con.close()
    return rows

# ğŸ“Œ ê²€ìƒ‰ê¸°ë¡ ê¸°ë°˜ ì¶”ì²œ
def recommend_from_search_history(user_id, top_k=24):
    """
    ìµœê·¼ ê²€ìƒ‰ì–´ â†’ TF-IDF ë²¡í„°í™” â†’ ì˜í™”ë“¤ê³¼ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚° â†’ ê°€ì¤‘ì¹˜ ë°˜ì˜ í›„ ìƒìœ„ ì¶”ì²œ
    (ìœ íŠœë¸Œ 'ìµœê·¼ ê²€ìƒ‰ ê¸°ë°˜ ì¶”ì²œ' ê°™ì€ ë°©ì‹)
    """
    queries = get_recent_searches(user_id)
    if not queries: 
        return pd.DataFrame()

    # ìµœê·¼ì¼ìˆ˜ë¡ ê°€ì¤‘ì¹˜ â†‘
    weights = [0.85**i for i in range(len(queries))]
    scores = np.zeros(X.shape[0])

    for q, w in zip(queries, weights):
        try:
            q_vec = vec.transform([q])
            sim = (q_vec @ X.T).toarray().ravel()
            scores += sim * w
        except: 
            pass

    # â€˜ê´€ì‹¬ì—†ìŒâ€™ ì œì™¸
    dismissed = get_seen_movies(user_id)
    movie_ids = df["id"].fillna(-1).astype(int).tolist()

    # ì ìˆ˜ ìƒìœ„ top_kê°œë§Œ ì¶”ì¶œ
    result_idx = []
    for i in np.argsort(-scores):
        if movie_ids[i] not in dismissed:
            result_idx.append(i)
        if len(result_idx) >= top_k: break

    result = df.iloc[result_idx].copy().reset_index(drop=True)
    result["similarity"] = ((scores[result_idx]-scores[result_idx].min())/
                            (scores[result_idx].ptp()+1e-9)).round(3)
    return result

2.íšŒì›ê°€ì…ì‹œ ë‹‰ë„¤ì„ ì €ì¥í•˜ëŠ” ì½”ë“œ
def create_user(username, email, password, nickname):
    """íšŒì›ê°€ì… ì‹œ ë‹‰ë„¤ì„ê¹Œì§€ í•¨ê»˜ ì €ì¥"""
    con=_conn(); cur=con.cursor()
    cur.execute("""
        INSERT INTO users (username,email,password_hash,nickname,role,created_at)
        VALUES (?,?,?,?,?,?)
    """,(username,email,pwd_hash.hash(password),nickname,"user",
         datetime.utcnow().isoformat()))
    con.commit(); con.close()

  3.ë¡œê·¸ì¸ì‹œ ë‹‰ë„¤ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
def user_by_username(username):
    """ë¡œê·¸ì¸ ì‹œ nickname í¬í•¨í•´ì„œ ê°€ì ¸ì˜¤ê¸°"""
    con=_conn(); cur=con.cursor()
    cur.execute("""
        SELECT id,username,email,password_hash,nickname,role,created_at,last_login
        FROM users WHERE username=?
    """,(username,))
    row=cur.fetchone(); con.close()
    if row:
        keys=["id","username","email","password_hash","nickname","role","created_at","last_login"]
        return dict(zip(keys,row))
    return None
4.ë¡œê·¸ì¸ ì„±ê³µ í›„ ì„¸ì…˜ì— nickname ì €ì¥
    st.session_state["auth_user"] = {
    k: user[k] for k in ("id","username","email","nickname","role","created_at","last_login")
}
5.ë‚´ í˜ì´ì§€ì—ì„œ ë‹‰ë„¤ì„ ë³€ê²½í•˜ê¸°
st.subheader("ğŸ™‚ ë‹‰ë„¤ì„ ë³€ê²½")

current_nick = user.get("nickname") or user["username"]
new_nick = st.text_input("ë‹‰ë„¤ì„", value=current_nick)

if st.button("ì €ì¥"):
    con=_conn(); cur=con.cursor()
    cur.execute("UPDATE users SET nickname=? WHERE id=?",(new_nick.strip(),user["id"]))
    con.commit(); con.close()

    st.session_state["auth_user"]["nickname"] = new_nick.strip()
    st.success("ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ!")
    st.rerun()

