# --- [Auth Block] SQLite + Passlib í•´ì‹œ + Streamlit ì¸ì¦ UI -------------------
import sqlite3
import time
import re
from datetime import datetime
from typing import Optional, Dict, Any

import streamlit as st
from passlib.hash import bcrypt  # ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ì„ ìœ„í•œ í•´ì‹œ í•¨ìˆ˜ (ê²€ì¦ì€ verify)

DB_PATH = "users.db"

# ---------------------------------------------------------------------
# 0) DB ì—°ê²° ë„ìš°ë¯¸
# ---------------------------------------------------------------------
def _conn() -> sqlite3.Connection:
    """
    SQLite ì»¤ë„¥ì…˜ì„ ìƒì„±í•œë‹¤.
    - check_same_thread=False : Streamlitì´ ë©€í‹°ìŠ¤ë ˆë“œì²˜ëŸ¼ ì½œë°±ì„ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ê³µìœ .
    """
    return sqlite3.connect(DB_PATH, check_same_thread=False)


# ---------------------------------------------------------------------
# 1) DB ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”  (users / user_ratings / user_favorites + ê¸°ë³¸ admin)
# ---------------------------------------------------------------------
def init_db() -> None:
    """
    í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³ , ê¸°ë³¸ admin ê³„ì •ì„ ë³´ì¥í•œë‹¤.
    """
    con = _conn()
    cur = con.cursor()

    # íšŒì› í…Œì´ë¸”
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,  -- ë‚´ë¶€ ì‹ë³„ì(PK)
        username TEXT UNIQUE NOT NULL,         -- ë¡œê·¸ì¸ ì•„ì´ë””(ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´ 3~20)
        email    TEXT UNIQUE,                  -- ì´ë©”ì¼(ì„ íƒ)
        password_hash TEXT NOT NULL,           -- bcrypt í•´ì‹œ ì €ì¥
        role TEXT DEFAULT 'user',              -- ê¶Œí•œ: 'user' | 'admin'
        created_at TEXT,                       -- ê°€ì… ì‹œê°(UTC ISO8601)
        last_login TEXT                        -- ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°(UTC ISO8601)
    )
    """)

    # ì˜í™” í‰ì  í…Œì´ë¸”
    cur.execute("""
    CREATE TABLE IF NOT EXISTS user_ratings (
        user_id INTEGER NOT NULL,              -- í‰ì ì„ ë‚¨ê¸´ ì‚¬ìš©ì
        movie_id INTEGER NOT NULL,             -- ì˜í™” ID(ë„¤ ë°ì´í„° ê¸°ì¤€)
        rating REAL NOT NULL,                  -- 0.5~5.0 ì‚¬ì´ ì ìˆ˜ ê¶Œì¥
        rated_at TEXT,                         -- í‰ê°€ ì‹œê°(UTC ISO8601)
        PRIMARY KEY (user_id, movie_id)        -- ë™ì¼ ì˜í™” ì¤‘ë³µ í‰ê°€ ë°©ì§€
    )
    """)

    # ì¦ê²¨ì°¾ê¸°(ë¶ë§ˆí¬) í…Œì´ë¸”
    cur.execute("""
    CREATE TABLE IF NOT EXISTS user_favorites (
        user_id INTEGER NOT NULL,
        movie_id INTEGER NOT NULL,
        created_at TEXT,
        PRIMARY KEY (user_id, movie_id)
    )
    """)

    con.commit()

    # ê¸°ë³¸ admin ê³„ì •ì´ ì—†ìœ¼ë©´ ìƒì„±
    cur.execute("SELECT 1 FROM users WHERE username = ?", ("admin",))
    if not cur.fetchone():
        cur.execute(
            "INSERT INTO users (username, email, password_hash, role, created_at) VALUES (?,?,?,?,?)",
            (
                "admin",
                "admin@example.com",
                bcrypt.hash("admin123"),          # ì£¼ì˜: ì‹¤ì œ ë°°í¬ ì‹œ ê°•í•œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½
                "admin",
                datetime.utcnow().isoformat() + "Z"
            )
        )
        con.commit()

    con.close()


# ---------------------------------------------------------------------
# 2) ì‚¬ìš©ì ê´€ë ¨ ì¿¼ë¦¬/ìœ í‹¸
# ---------------------------------------------------------------------
def user_by_username(username: str) -> Optional[Dict[str, Any]]:
    """
    usernameìœ¼ë¡œ ì‚¬ìš©ì 1ëª…ì„ ì¡°íšŒí•œë‹¤.
    ë°˜í™˜: dict or None
    """
    con = _conn()
    cur = con.cursor()
    cur.execute("""
        SELECT id, username, email, password_hash, role, created_at, last_login
        FROM users WHERE username=?
    """, (username,))
    row = cur.fetchone()
    con.close()

    if row:
        keys = ["id", "username", "email", "password_hash", "role", "created_at", "last_login"]
        return dict(zip(keys, row))
    return None


def create_user(username: str, email: Optional[str], password: str) -> None:
    """
    ì‹ ê·œ ì‚¬ìš©ì ìƒì„± (ë¹„ë°€ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ í•´ì‹œë¡œ ì €ì¥).
    - UNIQUE ì œì•½ìœ¼ë¡œ username/email ì¤‘ë³µ ì‹œ sqlite3.IntegrityError ë°œìƒ
    """
    con = _conn()
    cur = con.cursor()
    cur.execute("""
        INSERT INTO users (username, email, password_hash, role, created_at)
        VALUES (?,?,?,?,?)
    """, (username, email, bcrypt.hash(password), "user", datetime.utcnow().isoformat() + "Z"))
    con.commit()
    con.close()


def update_last_login(uid: int) -> None:
    """ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ì‹œê°ì„ ê¸°ë¡í•œë‹¤."""
    con = _conn()
    cur = con.cursor()
    cur.execute("UPDATE users SET last_login=? WHERE id=?", (datetime.utcnow().isoformat() + "Z", uid))
    con.commit()
    con.close()


def valid_username(u: str) -> bool:
    """ì•„ì´ë”” í˜•ì‹: ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´ 3~20ì."""
    return bool(re.fullmatch(r"[a-zA-Z0-9_]{3,20}", u))


def strong_pw(p: str) -> bool:
    """
    ë¹„ë°€ë²ˆí˜¸ ê°„ë‹¨ ê°•ë„ ì²´í¬:
    - 8ì ì´ìƒ
    - ì˜ë¬¸ 1ê°œ ì´ìƒ
    - ìˆ«ì 1ê°œ ì´ìƒ
    (ì¶”ê°€ë¡œ íŠ¹ìˆ˜ë¬¸ì, ëŒ€ë¬¸ì ë“±ì„ ìš”êµ¬í•˜ê³  ì‹¶ìœ¼ë©´ ì •ê·œì‹ ê°•í™”)
    """
    return len(p) >= 8 and re.search(r"[A-Za-z]", p) and re.search(r"\d", p)


# ---------------------------------------------------------------------
# 3) (ì„ íƒ) í‰ì /ì¦ê²¨ì°¾ê¸° helper â€” UI/ì¶”ì²œ ì‹œìŠ¤í…œê³¼ì˜ ì—°ê²°ìš©
# ---------------------------------------------------------------------
def set_rating(user_id: int, movie_id: int, rating: float) -> None:
    """
    ì‚¬ìš©ì í‰ì ì„ ì €ì¥/ê°±ì‹ í•œë‹¤.
    - ë™ì¼ (user_id, movie_id)ëŠ” PKë¡œ ì¤‘ë³µ ë¶ˆê°€ â†’ UPSERTë¥¼ ìœ„í•´ REPLACE ì „ëµ ì‚¬ìš©
    """
    con = _conn()
    cur = con.cursor()
    cur.execute("""
        INSERT INTO user_ratings (user_id, movie_id, rating, rated_at)
        VALUES (?,?,?,?)
        ON CONFLICT(user_id, movie_id) DO UPDATE SET
            rating=excluded.rating, rated_at=excluded.rated_at
    """, (user_id, movie_id, rating, datetime.utcnow().isoformat() + "Z"))
    con.commit()
    con.close()


def toggle_favorite(user_id: int, movie_id: int) -> bool:
    """
    ì¦ê²¨ì°¾ê¸°ë¥¼ í† ê¸€í•œë‹¤.
    - ì´ë¯¸ ìˆìœ¼ë©´ ì‚­ì œ(False ë°˜í™˜), ì—†ìœ¼ë©´ ì¶”ê°€(True ë°˜í™˜)
    """
    con = _conn()
    cur = con.cursor()
    cur.execute("SELECT 1 FROM user_favorites WHERE user_id=? AND movie_id=?", (user_id, movie_id))
    exists = cur.fetchone() is not None

    if exists:
        cur.execute("DELETE FROM user_favorites WHERE user_id=? AND movie_id=?", (user_id, movie_id))
        con.commit()
        con.close()
        return False
    else:
        cur.execute("""
            INSERT INTO user_favorites (user_id, movie_id, created_at)
            VALUES (?,?,?)
        """, (user_id, movie_id, datetime.utcnow().isoformat() + "Z"))
        con.commit()
        con.close()
        return True


# ---------------------------------------------------------------------
# 4) Streamlit ì¸ì¦ ê²Œì´íŠ¸
# ---------------------------------------------------------------------
def show_auth_gate() -> bool:
    """
    ë¡œê·¸ì¸/íšŒì›ê°€ì… UIë¥¼ ë Œë”ë§í•˜ê³ , ì„±ê³µ ì‹œ st.session_state['auth_user']ì—
    ìµœì†Œ ì •ë³´(id, username, email, role, created_at, last_login)ë¥¼ ë‹´ëŠ”ë‹¤.

    ë°˜í™˜: True(ì¸ì¦ ì™„ë£Œ) / False(ë¯¸ì¸ì¦)
    """
    st.session_state.setdefault("auth_user", None)

    # ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ ìƒë‹¨ ë°” + ë¡œê·¸ì•„ì›ƒ
    if st.session_state["auth_user"]:
        u = st.session_state["auth_user"]
        colL, colR = st.columns([3, 1], vertical_alignment="center")
        with colL:
            st.success(f"ğŸ‘‹ {u['username']} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (role: {u['role']})")
        with colR:
            if st.button("ë¡œê·¸ì•„ì›ƒ"):
                st.session_state["auth_user"] = None
                st.rerun()
        return True

    # ë¡œê·¸ì¸/íšŒì›ê°€ì… íƒ­
    st.markdown("### ğŸ” ë¡œê·¸ì¸ / íšŒì›ê°€ì…")
    tab_login, tab_join = st.tabs(["ë¡œê·¸ì¸", "íšŒì›ê°€ì…"])

    # -- ë¡œê·¸ì¸ íƒ­
    with tab_login:
        login_user = st.text_input("ì‚¬ìš©ìëª…", key="login_user")
        login_pw   = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password", key="login_pw")

        if st.button("ë¡œê·¸ì¸"):
            user = user_by_username(login_user.strip())
            if not user:
                st.error("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.")
            elif not bcrypt.verify(login_pw, user["password_hash"]):
                # ì¤‘ìš”: ë¹„ë°€ë²ˆí˜¸ í‰ë¬¸ ë¹„êµ ê¸ˆì§€. ë°˜ë“œì‹œ verifyë¡œ ê²€ì¦.
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            else:
                update_last_login(user["id"])
                # ì„¸ì…˜ì— ê³µê°œ ê°€ëŠ¥í•œ ìµœì†Œ í•„ë“œë§Œ ì €ì¥(í•´ì‹œ ê°’ ì œì™¸!)
                st.session_state["auth_user"] = {
                    k: user[k] for k in ("id", "username", "email", "role", "created_at", "last_login")
                }
                st.success("ë¡œê·¸ì¸ ì„±ê³µ! ì°½ì´ ê°±ì‹ ë©ë‹ˆë‹¤â€¦")
                time.sleep(0.3)
                st.rerun()

    # -- íšŒì›ê°€ì… íƒ­
    with tab_join:
        j_user = st.text_input("ì‚¬ìš©ìëª…(ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´, 3~20ì)", key="join_user")
        j_email= st.text_input("ì´ë©”ì¼(ì„ íƒ)", key="join_email")
        j_pw   = st.text_input("ë¹„ë°€ë²ˆí˜¸(8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì í¬í•¨ ê¶Œì¥)", type="password", key="join_pw")
        j_pw2  = st.text_input("ë¹„ë°€ë²ˆí˜¸ í™•ì¸", type="password", key="join_pw2")

        if st.button("íšŒì›ê°€ì…"):
            u = j_user.strip()
            if not valid_username(u):
                st.warning("ì‚¬ìš©ìëª… í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            elif j_pw != j_pw2:
                st.warning("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            elif not strong_pw(j_pw):
                st.warning("ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì í¬í•¨ ê¶Œì¥)")
            elif user_by_username(u):
                st.warning("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤.")
            else:
                try:
                    create_user(u, j_email.strip() or None, j_pw)
                    st.success("íšŒì›ê°€ì… ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.")
                except sqlite3.IntegrityError:
                    st.error("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì/ì´ë©”ì¼ì…ë‹ˆë‹¤.")
                except Exception as e:
                    st.error(f"íšŒì›ê°€ì… ì‹¤íŒ¨: {e}")

    return False


# ---------------------------------------------------------------------
# 5) ê°œì¸í™” ì¶”ì²œ ë²„íŠ¼ ì„¹ì…˜ (ì™¸ë¶€ì˜ ì¶”ì²œ í•¨ìˆ˜ ì£¼ì… ì‚¬ìš©)
# ---------------------------------------------------------------------
def render_personal_reco_section(recommend_for_user_func) -> None:
    """
    recommend_for_user_func: callable(user_id:int, top_k:int) -> pandas.DataFrame
      - ìµœì†Œ ì»¬ëŸ¼: ['title', 'poster_url'] (ì—†ìœ¼ë©´ placeholderë¡œ ëŒ€ì²´)
    """
    user = st.session_state.get("auth_user")

    if user and st.button("âœ¨ ë‚˜ë¥¼ ìœ„í•œ ê°œì¸í™” ì¶”ì²œ ë³´ê¸°"):
        # ì™¸ë¶€ ëª¨ë“ˆì˜ ì¶”ì²œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ (ì˜ˆ: í˜‘ì—…/ì½˜í…ì¸  ê¸°ë°˜ í˜¼í•© ëª¨ë¸)
        df = recommend_for_user_func(user["id"], top_k=20)

        if df is None or getattr(df, "empty", True):
            st.info("ê°œì¸í™” ë°ì´í„°ë¥¼ ë§Œë“¤ë ¤ë©´ ë¨¼ì € ëª‡ í¸ì— í‰ì ì„ ì£¼ì„¸ìš”! (4ì  ì´ìƒ ê¶Œì¥)")
            return

        st.markdown("### âœ¨ ê°œì¸í™” ì¶”ì²œ")
        cols = st.columns(5)
        placeholder = "https://via.placeholder.com/185x278?text=No+Image"
        for i, (_, row) in enumerate(df.iterrows()):
            with cols[i % 5]:
                st.image(row.get("poster_url") or placeholder, use_container_width=True)
                st.caption(str(row.get("title", "Untitled")))


# ---------------------------------------------------------------------
# 6) ë¼ì´íŠ¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
# ---------------------------------------------------------------------
def render_admin() -> None:
    """
    ê´€ë¦¬ì ì „ìš©ì˜ ê°„ë‹¨í•œ ì¹´ìš´íŠ¸ ëŒ€ì‹œë³´ë“œ.
    - ì ‘ê·¼ ì¡°ê±´: ë¡œê·¸ì¸ + role == 'admin'
    """
    user = st.session_state.get("auth_user")
    if not (user and user.get("role") == "admin"):
        st.info("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥")
        return

    st.subheader("ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (ë¼ì´íŠ¸)")

    con = _conn()
    cur = con.cursor()
    cur.execute("SELECT COUNT(*) FROM users"); users_n = cur.fetchone()[0]
    cur.execute("SELECT COUNT(*) FROM user_ratings"); ratings_n = cur.fetchone()[0]
    cur.execute("SELECT COUNT(*) FROM user_favorites"); fav_n = cur.fetchone()[0]
    con.close()

    c1, c2, c3 = st.columns(3)
    c1.metric("ê°€ì…ì ìˆ˜", users_n)
    c2.metric("í‰ê°€ ìˆ˜", ratings_n)
    c3.metric("ì¦ê²¨ì°¾ê¸° ìˆ˜", fav_n)


# ---------------------------------------------------------------------
# 7) ëª¨ë“ˆ ì´ˆê¸°í™”(ì•± ì‹œì‘ ì‹œ 1íšŒ)
# ---------------------------------------------------------------------
init_db()

# (ì˜ˆì‹œ) Streamlit ë©”ì¸ì—ì„œì˜ ì‚¬ìš© ë°©ë²•:
# --------------------------------------
# authed = show_auth_gate()
# if authed:
#     # ì¶”ì²œ ì„¹ì…˜ (ì™¸ë¶€ ì¶”ì²œ í•¨ìˆ˜ ì£¼ì…)
#     render_personal_reco_section(recommend_for_user)
#
#     # ê´€ë¦¬ì í˜ì´ì§€
#     with st.expander("ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì—´ê¸°"):
#         render_admin()
