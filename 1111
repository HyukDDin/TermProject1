-- =========================================================
-- 1) ì¦ê²¨ì°¾ê¸° í…Œì´ë¸” : user_favorites
--    - "ì–´ë–¤ ì‚¬ìš©ìê°€ ì–´ë–¤ ì˜í™”ë¥¼ ì¦ê²¨ì°¾ê¸°í–ˆëŠ”ì§€" ì €ì¥
-- =========================================================
CREATE TABLE IF NOT EXISTS user_favorites (
    user_id   INTEGER NOT NULL,  -- ì‚¬ìš©ì ë²ˆí˜¸
    movie_id  INTEGER NOT NULL,  -- ì˜í™” ë²ˆí˜¸
    created_at TEXT,             -- ì¦ê²¨ì°¾ê¸°í•œ ë‚ ì§œ/ì‹œê°„(ë¬¸ìì—´ë¡œ ì €ì¥)
    PRIMARY KEY (user_id, movie_id)  -- ê°™ì€ ì˜í™” ì¦ê²¨ì°¾ê¸° ì¤‘ë³µ ì €ì¥ ë°©ì§€
);

-- =========================================================
-- 2) ê´€ì‹¬ì—†ìŒ í…Œì´ë¸” : user_dismissed
--    - "ì–´ë–¤ ì‚¬ìš©ìê°€ ì–´ë–¤ ì˜í™”ë¥¼ ê´€ì‹¬ì—†ìŒ(ìˆ¨ê¹€) ì²˜ë¦¬í–ˆëŠ”ì§€" ì €ì¥
-- =========================================================
CREATE TABLE IF NOT EXISTS user_dismissed (
    user_id   INTEGER NOT NULL,  -- ì‚¬ìš©ì ë²ˆí˜¸
    movie_id  INTEGER NOT NULL,  -- ì˜í™” ë²ˆí˜¸
    created_at TEXT,             -- ê´€ì‹¬ì—†ìŒìœ¼ë¡œ í‘œì‹œí•œ ë‚ ì§œ/ì‹œê°„
    PRIMARY KEY (user_id, movie_id)  -- ê°™ì€ ì˜í™” ì¤‘ë³µ ì €ì¥ ë°©ì§€
);
from datetime import datetime

# -------------------------------------------
# 2-1. get_favorites(user_id)
#    â†’ ì´ ì‚¬ìš©ìê°€ ì¦ê²¨ì°¾ê¸°í•œ ì˜í™” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
# -------------------------------------------

def get_favorites(user_id: int) -> set[int]:
    """
    ì£¼ì–´ì§„ user_idê°€ ì¦ê²¨ì°¾ê¸°í•œ ì˜í™”ë“¤ì˜ movie_id ì§‘í•©ì„ ëŒë ¤ì¤€ë‹¤.

    ì˜ˆ) user_id = 1 ì´ê³ 
        user_favoritesì— (1,101), (1,205)ê°€ ë“¤ì–´ìˆë‹¤ë©´
        {101, 205} ë¥¼ ë°˜í™˜í•œë‹¤.
    """
    con = _conn()
    cur = con.cursor()

    # user_favorites í…Œì´ë¸”ì—ì„œ ì´ ì‚¬ìš©ìì˜ ì˜í™” ë²ˆí˜¸ë§Œ ë½‘ê¸°
    cur.execute(
        "SELECT movie_id FROM user_favorites WHERE user_id=?",
        (user_id,)
    )
    # fetchall() ê²°ê³¼ì—ì„œ ì²« ë²ˆì§¸ ì¹¸(movie_id)ë§Œ ë½‘ì•„ì„œ setìœ¼ë¡œ ë³€í™˜
    movie_ids = {int(row[0]) for row in cur.fetchall()}

    con.close()
    return movie_ids


# -------------------------------------------
# 2-2. toggle_favorite(user_id, movie_id)
#    â†’ ì¦ê²¨ì°¾ê¸° ON/OFF í† ê¸€
# -------------------------------------------

def toggle_favorite(user_id: int, movie_id: int) -> bool:
    """
    ì¦ê²¨ì°¾ê¸°ë¥¼ 'í† ê¸€'í•˜ëŠ” í•¨ìˆ˜

    - ë§Œì•½ (user_id, movie_id)ê°€ ì´ë¯¸ í…Œì´ë¸”ì— ìˆìœ¼ë©´ â†’ ì‚­ì œ(ì¦ê²¨ì°¾ê¸° í•´ì œ)
      ê·¸ë¦¬ê³  Falseë¥¼ ë¦¬í„´
    - ì—†ìœ¼ë©´ â†’ ìƒˆë¡œ INSERT(ì¦ê²¨ì°¾ê¸° ì¶”ê°€)
      ê·¸ë¦¬ê³  Trueë¥¼ ë¦¬í„´

    ì´ë ‡ê²Œ í•˜ë©´ ë²„íŠ¼ í•˜ë‚˜ë¡œ "ì¦ê²¨ì°¾ê¸° ì¶”ê°€ / í•´ì œ"ë¥¼ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
    """
    con = _conn()
    cur = con.cursor()

    # 1ë‹¨ê³„: ì´ë¯¸ ì¦ê²¨ì°¾ê¸° ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    cur.execute(
        "SELECT 1 FROM user_favorites WHERE user_id=? AND movie_id=?",
        (user_id, movie_id)
    )
    found = cur.fetchone()

    if found:
        # ì´ë¯¸ ì¦ê²¨ì°¾ê¸° ë˜ì–´ ìˆìœ¼ë©´ â†’ ì‚­ì œ = ì¦ê²¨ì°¾ê¸° í•´ì œ
        cur.execute(
            "DELETE FROM user_favorites WHERE user_id=? AND movie_id=?",
            (user_id, movie_id)
        )
        con.commit()
        con.close()
        return False  # í•´ì œë¨

    # ê¸°ë¡ì´ ì—†ìœ¼ë©´ â†’ ìƒˆë¡œ INSERT = ì¦ê²¨ì°¾ê¸° ì¶”ê°€
    cur.execute(
        "INSERT INTO user_favorites (user_id, movie_id, created_at) VALUES (?,?,?)",
        (user_id, movie_id, datetime.utcnow().isoformat())
    )
    con.commit()
    con.close()
    return True  # ìƒˆë¡œ ì¶”ê°€ë¨
import streamlit as st

# -------------------------------------------
# 3-1. get_dismissed(user_id)
#    â†’ ì´ ì‚¬ìš©ìê°€ 'ê´€ì‹¬ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œí•œ ì˜í™” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
# -------------------------------------------

def get_dismissed(user_id: int) -> set[int]:
    """
    ì£¼ì–´ì§„ user_idê°€ 'ê´€ì‹¬ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œí•œ ì˜í™”ë“¤ì˜ movie_id ì§‘í•©ì„ ëŒë ¤ì¤€ë‹¤.
    """
    con = _conn()
    cur = con.cursor()

    cur.execute(
        "SELECT movie_id FROM user_dismissed WHERE user_id=?",
        (user_id,)
    )
    movie_ids = {int(row[0]) for row in cur.fetchall()}

    con.close()
    return movie_ids


# -------------------------------------------
# 3-2. add_dismissed(movie_id)
#    â†’ ê´€ì‹¬ì—†ìŒ ì¶”ê°€ (í™”ë©´ì—ì„œ ë°”ë¡œ ìˆ¨ê¸°ê¸° + DBì—ë„ ì €ì¥)
# -------------------------------------------

def add_dismissed(movie_id: int):
    """
    í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ,
    1) í™”ë©´ì—ì„œ ë°”ë¡œ ì´ ì˜í™”ë¥¼ ìˆ¨ê¸°ê³ (ì„¸ì…˜ì— ê¸°ë¡)
    2) DB(user_dismissed)ì— 'ê´€ì‹¬ì—†ìŒ'ìœ¼ë¡œ ì €ì¥í•œë‹¤.
    """

    # 1) í™”ë©´ì—ì„œ ë°”ë¡œ ìˆ¨ê¸°ê¸° ìœ„í•´, ì„¸ì…˜ì— movie_idë¥¼ ì €ì¥
    #    - _dismiss : ì´ ì„¸ì…˜ì—ì„œ 'ìˆ¨ê²¨ì•¼ í•  ì˜í™” id' ëª¨ìŒ
    st.session_state.setdefault("_dismiss", set())
    st.session_state["_dismiss"].add(int(movie_id))

    # 2) ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    user = st.session_state.get("auth_user")
    if not user:
        # ë¡œê·¸ì¸ ì•ˆ í•œ ê²½ìš°ì—ëŠ” DBì— ì €ì¥í•˜ì§€ ì•Šê³  í™”ë©´ì—ì„œë§Œ ìˆ¨ê¹€
        return

    # 3) DBì— ê´€ì‹¬ì—†ìŒ ê¸°ë¡ ì €ì¥
    con = _conn()
    cur = con.cursor()

    # INSERT OR IGNORE :
    #   ê°™ì€ (user_id, movie_id)ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ â†’ ì¤‘ë³µ ë°©ì§€
    cur.execute(
        """
        INSERT OR IGNORE INTO user_dismissed (user_id, movie_id, created_at)
        VALUES (?,?,?)
        """,
        (int(user["id"]), int(movie_id), datetime.utcnow().isoformat())
    )

    con.commit()
    con.close()


# -------------------------------------------
# 3-3. remove_dismissed(user_id, movie_id)
#    â†’ ê´€ì‹¬ì—†ìŒ í•´ì œ (DB + ì„¸ì…˜ ë‘˜ ë‹¤ì—ì„œ ì‚­ì œ)
# -------------------------------------------

def remove_dismissed(user_id: int, movie_id: int):
    """
    'ê´€ì‹¬ì—†ìŒ'ì„ ì·¨ì†Œí•˜ëŠ” í•¨ìˆ˜

    - DBì˜ user_dismissed í…Œì´ë¸”ì—ì„œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ê³ 
    - ì„¸ì…˜(_dismiss)ì—ì„œë„ ì´ movie_idë¥¼ ì œê±°í•œë‹¤.
    ê·¸ëŸ¬ë©´ ì¶”ì²œ ëª©ë¡ì— ë‹¤ì‹œ ì´ ì˜í™”ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆë‹¤.
    """
    # 1) DBì—ì„œ ì‚­ì œ
    con = _conn()
    cur = con.cursor()

    cur.execute(
        "DELETE FROM user_dismissed WHERE user_id=? AND movie_id=?",
        (int(user_id), int(movie_id))
    )
    con.commit()
    con.close()

    # 2) í˜„ì¬ ì„¸ì…˜ì—ì„œë„ ì œê±° (í™”ë©´ ìƒˆë¡œê³ ì¹¨ ì‹œ ë‹¤ì‹œ ë³´ì´ê²Œ)
    st.session_state.setdefault("_dismiss", set())
    st.session_state["_dismiss"].discard(int(movie_id))
# ----------------------------------------------------------
# ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ì´ ë§Œë“  ê²°ê³¼ DataFrame: result
#   - result["id"] : ì˜í™”ì˜ movie_id
#   - resultì—ëŠ” ì›ë˜ ì¶”ì²œëœ ì˜í™”ë“¤ì´ ë‹¤ ë“¤ì–´ìˆë‹¤.
# ì•„ë˜ ì½”ë“œëŠ” 'ê´€ì‹¬ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œí•œ ì˜í™”ëŠ” ë¹¼ê³  ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.
# ----------------------------------------------------------

# ì„¸ì…˜ì— ì €ì¥ëœ ìˆ¨ê¹€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: {101, 205, 333} ì´ëŸ° ì§‘í•©)
dismissed = st.session_state.get("_dismiss", set())

if "id" in result.columns and dismissed:
    # result["id"]ê°€ dismissed ì§‘í•©ì— ì†í•˜ëŠ” ì˜í™”ëŠ” ëª¨ë‘ ì œê±°
    result = result[~result["id"].astype(int).isin(dismissed)]
    # ì´ë ‡ê²Œ í•´ì„œ 'ê´€ì‹¬ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œí•œ ì˜í™”ëŠ” ì¶”ì²œ ê²°ê³¼ì— ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ”ë‹¤.
# ----------------------------------------------------------
# ì¶”ì²œ ì¹´ë“œ í•œ ì¥ì„ ê·¸ë¦´ ë•Œ ì‚¬ìš©í•˜ëŠ” ì˜ˆì‹œ ì½”ë“œ
# - "â˜… ì¦ê²¨ì°¾ê¸°" ë²„íŠ¼
# - "ê´€ì‹¬ì—†ìŒ" ë²„íŠ¼
# ë‘ ë²„íŠ¼ì„ í†µí•´ ìœ„ì—ì„œ ë§Œë“  í•¨ìˆ˜ë“¤ì´ ì‹¤ì œë¡œ ì–´ë–»ê²Œ ì“°ì´ëŠ”ì§€ ë³´ì—¬ì¤€ë‹¤.
# ----------------------------------------------------------

user = st.session_state.get("auth_user")
user_id = user["id"] if user else None

mid = int(row.get("id") or -1)  # í˜„ì¬ ì¹´ë“œê°€ ê°€ë¦¬í‚¤ëŠ” ì˜í™”ì˜ movie_id

# ì‘ì€ ë²„íŠ¼ë“¤ì„ í•œ ì¤„ì— ë°°ì¹˜í•˜ëŠ” ì˜ˆì‹œ
col1, col2 = st.columns(2)

with col1:
    if st.button("â˜… ì¦ê²¨ì°¾ê¸°", key=f"fav_{mid}"):
        if user_id is not None and mid != -1:
            added = toggle_favorite(user_id, mid)  # Trueë©´ ì¶”ê°€, Falseë©´ í•´ì œ
            if added:
                st.toast("ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. â­")
            else:
                st.toast("ì¦ê²¨ì°¾ê¸°ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.", icon="âŒ")

with col2:
    if st.button("ê´€ì‹¬ì—†ìŒ", key=f"dismiss_{mid}"):
        if user_id is not None and mid != -1:
            add_dismissed(mid)  # ì„¸ì…˜ + DBì— ê´€ì‹¬ì—†ìŒ ê¸°ë¡
            st.toast("ì´ ì˜í™”ë¥¼ ì¶”ì²œì—ì„œ ìˆ¨ê²¼ìŠµë‹ˆë‹¤.", icon="ğŸš«")
            st.rerun()  # ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 
