from sklearn.feature_extraction.text import TfidfVectorizer

# ëª¨ë¸ 2ì— ì‚¬ìš©í•  ì˜í™” ëª©ë¡ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
# final_dfì—ì„œ ì¤‘ë³µëœ ì˜í™”ë¥¼ ì œê±°í•˜ê³ , í•œê¸€ ì œëª©ê³¼ ì¥ë¥´ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
movies_df = final_df.drop_duplicates(subset='title_ko').copy()
movies_df = movies_df[['title_ko', 'genres']].set_index('title_ko')

# '|'ë¡œ ì—°ê²°ëœ ì¥ë¥´ë¥¼ ê³µë°±ìœ¼ë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤. (ì˜ˆ: 'Action|Adventure' -> 'Action Adventure')
movies_df['genres'] = movies_df['genres'].str.replace('|', ' ', regex=False)

# TF-IDF ë²¡í„°í™”ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
# TfidfVectorizerëŠ” í…ìŠ¤íŠ¸(ì¥ë¥´)ì—ì„œ ì¤‘ìš”í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì—¬ ìˆ«ì ë²¡í„°ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.
tfidf_vectorizer = TfidfVectorizer()
tfidf_matrix = tfidf_vectorizer.fit_transform(movies_df['genres'])

print("âœ… TF-IDF í–‰ë ¬ ìƒì„± ì™„ë£Œ!")
print(f"ë¶„ì„í•  ì˜í™” ìˆ˜: {tfidf_matrix.shape[0]}í¸, ê³ ìœ  ì¥ë¥´ ìˆ˜: {tfidf_matrix.shape[1]}ê°œ")

from surprise import Dataset, Reader
from surprise.model_selection import train_test_split

# 1. Surprise ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì½ì„ ìˆ˜ ìˆë„ë¡ ë°ì´í„° í˜•ì‹ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
#    'rating' ì»¬ëŸ¼ì˜ ë²”ìœ„ë¥¼ ì§€ì •í•´ì¤ë‹ˆë‹¤. (ì˜ˆ: 0.5 ~ 5.0ì )
reader = Reader(rating_scale=(0.5, 5.0))

# 2. 'userId', 'movieId', 'rating_x'(ì‚¬ìš©ì í‰ì ) ì»¬ëŸ¼ë§Œ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
data = Dataset.load_from_df(final_df[['userId', 'movieId', 'rating']], reader)

# 3. ë°ì´í„°ë¥¼ í›ˆë ¨ ì„¸íŠ¸ì™€ í…ŒìŠ¤íŠ¸ ì„¸íŠ¸ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
#    ëª¨ë¸ì˜ ì„±ëŠ¥ì„ í‰ê°€í•˜ê¸° ìœ„í•œ ê³¼ì •ì…ë‹ˆë‹¤.
trainset, testset = train_test_split(data, test_size=0.2, random_state=42)

print("âœ… Surprise ë¼ì´ë¸ŒëŸ¬ë¦¬ìš© ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ!")

from surprise import SVD
from surprise import accuracy

# 1. SVD ì•Œê³ ë¦¬ì¦˜ ëª¨ë¸ì„ ì„ ì–¸í•©ë‹ˆë‹¤.
algo = SVD()

# 2. í›ˆë ¨ ë°ì´í„°(trainset)ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ í›ˆë ¨ì‹œí‚µë‹ˆë‹¤.
print("ëª¨ë¸ í›ˆë ¨ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
algo.fit(trainset)
print("ëª¨ë¸ í›ˆë ¨ ì™„ë£Œ!")

# 3. í…ŒìŠ¤íŠ¸ ë°ì´í„°(testset)ì— ëŒ€í•œ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
predictions = algo.test(testset)

# RMSEë¥¼ ê³„ì‚°í•˜ì—¬ ëª¨ë¸ì˜ ì˜ˆì¸¡ ì •í™•ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
print("\\n## ëª¨ë¸ ì„±ëŠ¥ í‰ê°€ (RMSE)")
accuracy.rmse(predictions)

def get_recommendations(user_id, n=10):
    # 1. ì‚¬ìš©ìê°€ ì´ë¯¸ í‰ê°€í•œ ì˜í™”ë“¤ì˜ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    rated_movies = final_df[final_df['userId'] == user_id]['movieId'].tolist()

    # 2. ì „ì²´ ì˜í™” ëª©ë¡ì—ì„œ ì‚¬ìš©ìê°€ ì´ë¯¸ ë³¸ ì˜í™”ë¥¼ ì œì™¸í•©ë‹ˆë‹¤.
    all_movies = final_df['movieId'].unique()
    unrated_movies = [movie for movie in all_movies if movie not in rated_movies]

    # 3. ì•„ì§ ì•ˆ ë³¸ ì˜í™”ë“¤ì— ëŒ€í•´ ì˜ˆìƒ í‰ì ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
    predictions = [algo.predict(user_id, movie_id) for movie_id in unrated_movies]

    # 4. ì˜ˆìƒ í‰ì ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
    predictions.sort(key=lambda x: x.est, reverse=True)

    # 5. ìƒìœ„ nê°œì˜ ì¶”ì²œ ì˜í™” IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    top_n_predictions = predictions[:n]
    recommended_movie_ids = [pred.iid for pred in top_n_predictions]

    # 6. ì˜í™” IDë¥¼ ì‹¤ì œ í•œê¸€ ì œëª©ê³¼ ì¥ë¥´ë¡œ ë°”ê¿”ì„œ ë°˜í™˜í•©ë‹ˆë‹¤.
    recommended_movies = final_df[final_df['movieId'].isin(recommended_movie_ids)][['title_ko', 'genres']]
    
    # ì¤‘ë³µì„ ì œê±°í•˜ê³  ì»¬ëŸ¼ ì´ë¦„ì„ ì§€ì •í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
    final_recommendations = recommended_movies.drop_duplicates(subset='title_ko').set_index('title_ko')
    final_recommendations.index.name = 'ì˜í™” ì œëª©'
    final_recommendations.columns = ['ì¥ë¥´']
    
    return final_recommendations

# --- í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ---
# user_id=550 ë¶€ë¶„ì„ ì›í•˜ëŠ” ì‚¬ìš©ì IDë¡œ ë°”ê¿”ì„œ ì‹¤í–‰í•˜ì„¸ìš”.
user_id_to_recommend = 550
print(f"ğŸ† {user_id_to_recommend}ë²ˆ ì‚¬ìš©ìë¥¼ ìœ„í•œ ë§ì¶¤ ì˜í™” ì¶”ì²œ Top 10")
display(get_recommendations(user_id=user_id_to_recommend, n=10))

# CSV ì •ë¦¬: movies_details.csv â†’ movies_details_clean.csv
import pandas as pd
from ast import literal_eval
import os

CSV_PATH = r"C:\Users\soft88\Desktop\í…€í”„\movies_details.csv"  # ì ˆëŒ€ê²½ë¡œë¡œ ê³ ì •
df = pd.read_csv(CSV_PATH)

# ê²°ì¸¡ì¹˜ ì±„ìš°ê¸°
for col in ["genres", "keywords", "director", "cast", "overview", "title"]:
    if col in df.columns:
        df[col] = df[col].fillna("")

# ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ ì €ì¥ëœ ë¬¸ìì—´ì„ ì‹¤ì œ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
def to_list(x):
    if isinstance(x, list):
        return x
    s = str(x).strip()
    if s.startswith("[") and s.endswith("]"):
        try:
            return list(map(str, literal_eval(s)))
        except:
            pass
    # ì½¤ë§ˆ/ìŠ¬ë˜ì‹œë¡œ ëŒ€ì¶© ë‚˜ë‰˜ì–´ ìˆìœ¼ë©´ ë¶„ë¦¬
    return [t.strip() for t in s.replace("/", ",").split(",") if t.strip()]

for col in ["genres", "keywords", "cast"]:
    if col in df.columns:
        df[col] = df[col].apply(to_list)

# ì¤‘ë³µ ì œê±°
if "id" in df.columns:
    df = df.drop_duplicates(subset="id", keep="first")

CLEAN_PATH = r"C:\Users\soft88\Desktop\í…€í”„\movies_details_clean.csv"
df.to_csv(CLEAN_PATH, index=False, encoding="utf-8-sig")
print("âœ… ì €ì¥ ì™„ë£Œ:", CLEAN_PATH, df.shape)
df.head(3)
