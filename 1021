# app.py â€” ì˜í™” ì¶”ì²œ (Content-based) + ì¹´ë“œ/ëª¨ë‹¬ + í•„í„°/ì •ë ¬ + CSV
# ì‹¤í–‰: streamlit run app.py

from pathlib import Path
from ast import literal_eval
import re
import os, requests, urllib.parse

import pandas as pd
import streamlit as st
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

st.set_page_config(page_title="ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ", page_icon="ğŸ¬", layout="wide")

# -------------------------------
# 0) CSV ê²½ë¡œ (clean ìš°ì„ )
# -------------------------------
HERE = Path(__file__).parent
CSV_PATH = (HERE / "movies_details_clean.csv") if (HERE / "movies_details_clean.csv").exists() else (HERE / "movies_details.csv")
if not CSV_PATH.exists():
    st.error("CSV íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. app.pyì™€ ê°™ì€ í´ë”ì— movies_details_clean.csv ë˜ëŠ” movies_details.csvë¥¼ ë‘ì„¸ìš”.")
    st.stop()

# -------------------------------
# 1) ë°ì´í„° ë¡œë“œ/ì •ì œ
# -------------------------------
@st.cache_data
def load_df(path: Path) -> pd.DataFrame:
    df = pd.read_csv(path)

    # ê²°ì¸¡ì¹˜
    for col in ["genres","keywords","cast","director","overview","title","poster_path","release_date","vote_average"]:
        if col in df.columns:
            df[col] = df[col].fillna("")

    # ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ ì •ê·œí™”
    def to_list(x):
        if isinstance(x, list):
            return x
        s = str(x).strip()
        if not s:
            return []
        if s.startswith("[") and s.endswith("]"):
            try:
                v = literal_eval(s)
                if isinstance(v, list):
                    return [str(t) for t in v]
            except:
                pass
        return [t.strip() for t in re.split(r"[,/|]", s) if t.strip()]

    if "genres"   in df.columns: df["genres"]   = df["genres"].apply(to_list)
    if "keywords" in df.columns: df["keywords"] = df["keywords"].apply(to_list)
    if "cast"     in df.columns: df["cast"]     = df["cast"].apply(to_list)

    # ì¶”ì²œìš© í…ìŠ¤íŠ¸ (ê°€ì¤‘ì¹˜ ì ìš©)
    df["combined_features"] = (
        (df["genres"].apply(" ".join)   + " ") * 3 +   # ì¥ë¥´ ê°€ì¤‘ì¹˜
        (df["keywords"].apply(" ".join) + " ") * 2 +   # í‚¤ì›Œë“œ ê°€ì¤‘ì¹˜
        (df["director"].astype(str)     + " ") * 2 +   # ê°ë… ê°€ì¤‘ì¹˜
        (df["cast"].apply(" ".join)     + " ") * 1 +   # ë°°ìš°
        df["overview"].astype(str)                       # ì¤„ê±°ë¦¬
    )

    # ì—°ë„ íŒŒìƒ
    df["release_year"] = pd.to_datetime(df.get("release_date", ""), errors="coerce").dt.year.fillna(0).astype(int)
    return df

df = load_df(CSV_PATH)
st.caption(f"ì½ì€ íŒŒì¼: {CSV_PATH.name} | í¬ìŠ¤í„° ìˆ˜: {(df['poster_path'].astype(str)!='').sum() if 'poster_path' in df.columns else 0}")

# -------------------------------
# 2) TF-IDF + ì½”ì‚¬ì¸ ìœ ì‚¬ë„
# -------------------------------
@st.cache_resource
def build_model(corpus):
    vec = TfidfVectorizer(stop_words=None, min_df=1, ngram_range=(1, 2))
    X = vec.fit_transform(corpus)
    sim = cosine_similarity(X, X)
    return vec, sim

_, cosine_sim = build_model(df["combined_features"])

# -------------------------------
# 3) ì¶”ì²œ í•¨ìˆ˜
# -------------------------------
def recommend_by_index(idx: int, k: int = 10) -> pd.DataFrame:
    sims = sorted(enumerate(cosine_sim[idx]), key=lambda x: x[1], reverse=True)
    sims = [s for s in sims if s[0] != idx][:k]           # ìê¸° ìì‹  ì œì™¸
    rec_idx = [i for i, _ in sims]

    cols = ["id","title","genres","vote_average","release_date","release_year","poster_path","overview"]
    cols = [c for c in cols if c in df.columns]
    out = df.iloc[rec_idx][cols].reset_index(drop=True).copy()

    if "genres" in out.columns:
        out["genres"] = out["genres"].apply(lambda xs: ", ".join(xs) if isinstance(xs, list) else str(xs))
    if "vote_average" in out.columns:
        out["vote_average"] = pd.to_numeric(out["vote_average"], errors="coerce").round(1)

    if "poster_path" in out.columns:
        base = "https://image.tmdb.org/t/p/w185"
        out["poster_url"] = out["poster_path"].apply(lambda p: base + p if isinstance(p, str) and p else None)

    out["similarity"] = [score for _, score in sims]
    out["similarity"] = out["similarity"].round(3)
    return out
# ---- YouTube ì˜ˆê³ í¸ URL ê°€ì ¸ì˜¤ê¸° (API í‚¤ ì—†ìœ¼ë©´ None) ----
@st.cache_data(show_spinner=False, ttl=60*60*24)
def fetch_youtube_trailer_url(title: str, year: int | None = None) -> str | None:
    """YouTube Data API v3ë¡œ '<ì œëª©> trailer (year)' ê²€ìƒ‰ â†’ ì²« ì˜ìƒ URL"""
    api_key = os.environ.get("YOUTUBE_API_KEY") or st.secrets.get("YOUTUBE_API_KEY", None)
    if not api_key:
        return None
    try:
        q = f"{title} trailer{f' {year}' if year else ''}"
        params = {
            "part": "snippet", "q": q, "type": "video",
            "maxResults": 1, "regionCode": "KR",
            "key": api_key, "safeSearch": "none",
        }
        r = requests.get("https://www.googleapis.com/youtube/v3/search", params=params, timeout=10)
        r.raise_for_status()
        items = r.json().get("items", [])
        if items:
            vid = items[0]["id"]["videoId"]
            return f"https://www.youtube.com/watch?v={vid}"
    except Exception:
        pass
    return None


# ---- ìƒì„¸ 'ëª¨ë‹¬' í˜¸í™˜: st.modal ì—†ìœ¼ë©´ ì‚¬ì´ë“œë°”ë¡œ í‘œì‹œ + ìœ íŠœë¸Œ ì˜ˆê³ í¸ ----
def show_detail_modal(row: pd.Series):
    has_modal = hasattr(st, "modal")  # ìµœì‹  ìŠ¤íŠ¸ë¦¼ë¦¿ì€ ëª¨ë‹¬ ì§€ì›

    # ì—°ë„(ì˜ˆê³ í¸ ê²€ìƒ‰ ì •í™•ë„ â†‘)
    year = None
    if isinstance(row.get("release_date"), str) and row["release_date"].strip():
        try:
            year = int(pd.to_datetime(row["release_date"], errors="coerce").year)
        except Exception:
            year = None

    def _body(container):
        # í¬ìŠ¤í„°
        url = row.get("poster_url") or "https://via.placeholder.com/185x278?text=No+Image"
        container.image(url, use_container_width=True)

        # ë©”íƒ€
        meta = []
        if pd.notna(row.get("release_date")) and row.get("release_date"):
            meta.append(f"ê°œë´‰: {row['release_date']}")
        if "vote_average" in row:
            meta.append(f"â­ {row['vote_average']}")
        if meta:
            container.write(" | ".join(meta))
        if row.get("genres"):
            container.write(row["genres"])

        # ì¤„ê±°ë¦¬
        if isinstance(row.get("overview"), str) and row["overview"].strip():
            container.markdown("---")
            container.write(row["overview"])

        # TMDB ë§í¬
        if "id" in row.index and pd.notna(row["id"]):
            tmdb_url = f"https://www.themoviedb.org/movie/{int(row['id'])}"
            container.markdown(f"[TMDBì—ì„œ ë³´ê¸°]({tmdb_url})")

        # ğŸï¸ ìœ íŠœë¸Œ ì˜ˆê³ í¸
        container.markdown("### ğŸï¸ ì˜ˆê³ í¸")
        yt_url = fetch_youtube_trailer_url(row.get("title", ""), year)
        if yt_url:
            container.video(yt_url)
        else:
            q = urllib.parse.quote(f"{row.get('title','')} trailer {year or ''}")
            container.link_button("YouTubeì—ì„œ ì˜ˆê³ í¸ ê²€ìƒ‰", f"https://www.youtube.com/results?search_query={q}")

        # ë‹«ê¸°
        if container.button("ë‹«ê¸°", key="close_detail"):
            st.session_state["open_modal"] = False
            st.session_state["detail_idx"] = None
            try:
                st.rerun()
            except Exception:
                st.experimental_rerun()

    if has_modal:
        with st.modal(row.get("title", "ìƒì„¸ ë³´ê¸°")):
            _body(st)
    else:
        st.sidebar.markdown(f"### {row.get('title','ìƒì„¸ ë³´ê¸°')}")
        _body(st.sidebar)



# -------------------------------
# 5) ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# -------------------------------
st.session_state.setdefault("result", None)
st.session_state.setdefault("open_modal", False)
st.session_state.setdefault("detail_idx", None)
st.session_state.setdefault("selected_title", "")

# -------------------------------
# 6) UI ì»¨íŠ¸ë¡¤
# -------------------------------
st.title("ğŸ¬ ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ (Content-based)")

# í•„í„°
all_genres = sorted({g for gs in df["genres"] for g in (gs if isinstance(gs, list) else [])})
sel_genres = st.multiselect("ì¥ë¥´ í•„í„°", options=all_genres)

year_min = int(df["release_year"].replace(0, pd.NA).min() or 1900)
year_max = int(df["release_year"].max() or 2100)
f_year = st.slider("ê°œë´‰ ì—°ë„", min_value=year_min, max_value=year_max, value=(year_min, year_max))
f_vote = st.slider("í‰ì  í•˜í•œ", 0.0, 10.0, 0.0, 0.5)
sort_by = st.radio("ì •ë ¬", ["ìœ ì‚¬ë„", "í‰ì "], horizontal=True)

# ê²€ìƒ‰/ì„ íƒ
left, right = st.columns([2,1])
with left:
    all_titles = sorted(df["title"].dropna().unique().tolist())
    hint = st.text_input("ë¹ ë¥¸ ê²€ìƒ‰(ë¶€ë¶„ ì¼ì¹˜)")
    list_for_select = [t for t in all_titles if (hint.lower() in t.lower())] if hint else all_titles
    selected_title = st.selectbox("ì˜í™” ì œëª© ì„ íƒ(íƒ€ì´í•‘í•´ì„œ ê²€ìƒ‰ ê°€ëŠ¥)", options=list_for_select)
    st.session_state["selected_title"] = selected_title
with right:
    k = st.slider("ì¶”ì²œ ê°œìˆ˜", 5, 20, 10)

# -------------------------------
# 7) ì¶”ì²œ ë²„íŠ¼ â†’ ì„¸ì…˜ì— ì €ì¥ í›„ rerun
# -------------------------------
if st.button("ì¶”ì²œ ë³´ê¸°"):
    base_idx = int(df.index[df["title"] == st.session_state["selected_title"]][0])
    result = recommend_by_index(base_idx, k).copy()

    # í•„í„°/ì •ë ¬ ì ìš©
    if "release_year" not in result.columns and "release_date" in result.columns:
        result["release_year"] = pd.to_datetime(result["release_date"], errors="coerce").dt.year
    if "vote_average" in result.columns:
        result["vote_average"] = pd.to_numeric(result["vote_average"], errors="coerce").fillna(0)

    if sel_genres:
        result = result[result["genres"].apply(
            lambda s: set(sel_genres).issubset(set(map(str.strip, s.split(","))))
            if isinstance(s, str) else False
        )]
    if "release_year" in result.columns:
        result = result[result["release_year"].between(f_year[0], f_year[1])]
    if "vote_average" in result.columns:
        result = result[result["vote_average"] >= f_vote]

    if sort_by == "í‰ì " and "vote_average" in result.columns:
        result = result.sort_values("vote_average", ascending=False)
    result = result.reset_index(drop=True)

    st.session_state["result"] = result
    st.session_state["open_modal"] = False
    st.session_state["detail_idx"] = None
    st.rerun()

# -------------------------------
# 8) ê²°ê³¼ ì¹´ë“œ ë Œë”ë§ + ë‹¤ìš´ë¡œë“œ
# -------------------------------
result = st.session_state.get("result")
if isinstance(result, pd.DataFrame) and not result.empty:
    cols = st.columns(5)
    placeholder = "https://via.placeholder.com/185x278?text=No+Image"
    for i, row in result.iterrows():
        with cols[i % 5]:
            url = row.get("poster_url") or placeholder
            st.image(url, use_container_width=True)
            st.caption(row["title"])
            meta = []
            if "vote_average" in row: meta.append(f"â­ {row['vote_average']}")
            meta.append(f"ìœ ì‚¬ë„ {row['similarity']}")
            st.write(" | ".join(meta))
            if "genres" in row: st.write(row["genres"])
            if st.button("ìƒì„¸ë³´ê¸°", key=f"detail_{i}"):
                st.session_state["open_modal"] = True
                st.session_state["detail_idx"] = i
                st.rerun()

    csv = result.to_csv(index=False).encode("utf-8-sig")
    st.download_button(
        "CSVë¡œ ì €ì¥",
        data=csv,
        file_name=f"recommend_{st.session_state.get('selected_title','selection')}.csv",
        mime="text/csv",
        type="primary",
    )

# -------------------------------
# 9) ëª¨ë‹¬ í‘œì‹œ (ì„¸ì…˜ ìƒíƒœ ê¸°ë°˜)
# -------------------------------
if st.session_state.get("open_modal") and st.session_state.get("detail_idx") is not None:
    i = st.session_state["detail_idx"]
    if isinstance(st.session_state.get("result"), pd.DataFrame) and 0 <= i < len(st.session_state["result"]):
        row = st.session_state["result"].iloc[i]
        show_detail_modal(row)

# -------------------------------
# 10) ë°ì´í„° ìƒ˜í”Œ
# -------------------------------
with st.expander("ë°ì´í„° ìƒ˜í”Œ ë³´ê¸°"):
    base_cols = [c for c in ["title","genres","vote_average","release_date","poster_path"] if c in df.columns]
    st.dataframe(df[base_cols].head(10))
