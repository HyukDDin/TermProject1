# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TMDB ìƒì„¸ í˜ì´ì§€ ë§í¬ ì¶œë ¥
# - ì „ì œ: 'row'ëŠ” ì¶”ì²œ ê²°ê³¼(ë˜ëŠ” ìƒì„¸ë³´ê¸°)ì—ì„œ ì„ íƒëœ ì˜í™” 1ê±´ì˜ pandas.Series
# - TMDBì˜ ì˜í™” ìƒì„¸ í˜ì´ì§€ëŠ” https://www.themoviedb.org/movie/<ì˜í™”ID> í˜•ì‹
# - CSVì— id ì»¬ëŸ¼ì´ ìˆê³ , í•´ë‹¹ ê°’ì´ ê²°ì¸¡ì´ ì•„ë‹ ë•Œë§Œ ë§í¬ë¥¼ ë…¸ì¶œí•œë‹¤.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (í•„ìš” ì‹œ) import pandas as pd
if "id" in row.index and pd.notna(row["id"]):          # rowì— 'id' ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ê³  ê°’ì´ ê²°ì¸¡ì´ ì•„ë‹Œì§€ í™•ì¸
    tmdb_url = f"https://www.themoviedb.org/movie/{int(row['id'])}"  # ì •ìˆ˜ ìºìŠ¤íŒ…í•˜ì—¬ ì•ˆì „í•œ URL êµ¬ì„±
    # st.markdownìœ¼ë¡œ í•˜ì´í¼ë§í¬ ì¶œë ¥ (ì‚¬ìš©ì í´ë¦­ ì‹œ TMDB ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™)
    st.markdown(f"[TMDBì—ì„œ ë³´ê¸°]({tmdb_url})")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ íŠœë¸Œ ì˜ˆê³ í¸ ì„ë² ë“œ
# - YouTube Data API v3ë¥¼ ì‚¬ìš©í•˜ì—¬ '<ì œëª©> trailer (ì—°ë„)'ë¡œ ê²€ìƒ‰ í›„ ì²« ê²°ê³¼ë¥¼ ê°€ì ¸ì˜´
# - API í‚¤ê°€ ì—†ìœ¼ë©´ Noneì„ ë°˜í™˜í•˜ì—¬ ë§í¬ ë²„íŠ¼(ê²€ìƒ‰ í˜ì´ì§€)ë¡œ ìš°íšŒ
# - ìš”ì²­/íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„ ì˜ˆì™¸ë¥¼ ì‚¼ì¼œ UXë¥¼ ìœ ì§€ (ì•± ì „ì²´ê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡)
# - ìºì‹œ(st.cache_data): ë™ì¼ ì¿¼ë¦¬ì— ëŒ€í•´ 24ì‹œê°„ ê²°ê³¼ ì¬ì‚¬ìš© â†’ API í˜¸ì¶œ/ì†ë„ ìµœì í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# í•„ìš” ëª¨ë“ˆ
import os, requests, urllib.parse
import streamlit as st
# (í•„ìš” ì‹œ) import pandas as pd

@st.cache_data(show_spinner=False, ttl=60*60*24)       # 24ì‹œê°„ ìºì‹œ: ë¶ˆí•„ìš”í•œ ì™¸ë¶€ API í˜¸ì¶œ ê°ì†Œ
def fetch_youtube_trailer_url(title: str, year: int | None = None) -> str | None:
    """
    YouTube Data API v3ë¡œ '<ì œëª©> trailer (year)' ê²€ìƒ‰ â†’ ì²« ì˜ìƒì˜ watch URLì„ ë°˜í™˜í•œë‹¤.
    - API í‚¤ ì†ŒìŠ¤:
        1) í™˜ê²½ë³€ìˆ˜: os.environ['YOUTUBE_API_KEY']
        2) Streamlit secrets: st.secrets['YOUTUBE_API_KEY']
      ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš©. ì—†ìœ¼ë©´ None.
    - yearë¥¼ í•¨ê»˜ ë„£ìœ¼ë©´ ê²€ìƒ‰ ì •í™•ë„ê°€ ë‹¤ì†Œ í–¥ìƒë  ìˆ˜ ìˆë‹¤.
    - ë°˜í™˜ í˜•ì‹: "https://www.youtube.com/watch?v=<videoId>" or None
    """
    # â‘  í™˜ê²½ë³€ìˆ˜ â†’ â‘¡ st.secrets ìˆœìœ¼ë¡œ ì¡°íšŒ
    api_key = os.environ.get("YOUTUBE_API_KEY") or st.secrets.get("YOUTUBE_API_KEY", None)
    if not api_key:
        # í‚¤ê°€ ì—†ìœ¼ë©´ ì„ë² ë“œ ëŒ€ì‹  ê²€ìƒ‰ ë²„íŠ¼(ì•„ë˜ fallback)ìœ¼ë¡œ ìœ ë„
        return None

    try:
        # ê²€ìƒ‰ ì§ˆì˜: "<ì˜í™”ì œëª©> trailer [ì—°ë„]"
        q = f"{title} trailer{f' {year}' if year else ''}"

        # YouTube Data API ê²€ìƒ‰ íŒŒë¼ë¯¸í„°
        params = {
            "part": "snippet",        # ìŠ¤ë‹ˆí« ë©”íƒ€ë°ì´í„°ë§Œ í•„ìš”
            "q": q,                   # ê²€ìƒ‰ì–´
            "type": "video",          # ë™ì˜ìƒë§Œ
            "maxResults": 1,          # ì²« ê²°ê³¼ 1ê°œë§Œ
            "regionCode": "KR",       # í•œêµ­ ê¸°ì¤€ ì¶”ì²œ/í•„í„° (ì›í•œë‹¤ë©´ ë³€ê²½ ê°€ëŠ¥)
            "key": api_key,           # API í‚¤ (ì¿¼í„°/ê³¼ê¸ˆ ìœ ì˜)
            "safeSearch": "none",     # ê²€ìƒ‰ ì•ˆì „ëª¨ë“œ (í•„ìš” ì‹œ 'moderate' ë“±ìœ¼ë¡œ)
        }

        # GET í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ 10ì´ˆë¡œ ë°©ì–´)
        r = requests.get("https://www.googleapis.com/youtube/v3/search", params=params, timeout=10)
        r.raise_for_status()          # HTTP ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸

        # JSON íŒŒì‹± í›„ ì²« ë²ˆì§¸ ê²°ê³¼ì˜ videoId ì¶”ì¶œ
        items = r.json().get("items", [])
        if items:
            vid = items[0]["id"]["videoId"]
            return f"https://www.youtube.com/watch?v={vid}"

    except Exception:
        # ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, JSON íŒŒì‹± ì˜¤ë¥˜, í‚¤ ì œí•œ ë“± ì–´ë–¤ ì´ìœ ë“  ì‹¤íŒ¨ ì‹œ None ë°˜í™˜
        pass

    return None


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì˜ˆê³ í¸ ì„¹ì…˜ UI
# - 'row'ì—ì„œ titleê³¼ release_dateë¥¼ ê°€ì ¸ì™€ ì—°ë„(year)ë¥¼ ìœ ì¶” (ì •í™•ë„â†‘)
# - API í‚¤ê°€ ìˆìœ¼ë©´ ë™ì˜ìƒ ì„ë² ë“œ(st.video), ì—†ìœ¼ë©´ ê²€ìƒ‰ ê²°ê³¼ ë§í¬ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("### ğŸï¸ ì˜ˆê³ í¸")

# 1) ì˜í™” ì œëª©
title = row.get("title", "")  # ì œëª©ì´ ì—†ë”ë¼ë„ ë¹ˆ ë¬¸ìì—´ë¡œ ì•ˆì „ ì²˜ë¦¬

# 2) ê°œë´‰ ì—°ë„ ì¶”ì¶œ (ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒìš©. ì‹¤íŒ¨ ì‹œ None)
year = None
if isinstance(row.get("release_date"), str) and row["release_date"].strip():
    try:
        # to_datetimeìœ¼ë¡œ ì•ˆì „í•˜ê²Œ íŒŒì‹± â†’ .year ì¶”ì¶œ
        year = int(pd.to_datetime(row["release_date"], errors="coerce").year)
    except Exception:
        year = None

# 3) URL ì¡°íšŒ (ìºì‹œ ì‚¬ìš©)
yt_url = fetch_youtube_trailer_url(title, year)

# 4) ì„ë² ë“œ or Fallback
if yt_url:
    # ì •ìƒì ìœ¼ë¡œ URLì„ ì–»ì—ˆë‹¤ë©´ ë™ì˜ìƒ ì„ë² ë“œ
    st.video(yt_url)
else:
    # API í‚¤ê°€ ì—†ê±°ë‚˜(ë˜ëŠ” ì‹¤íŒ¨)í•œ ê²½ìš°: YouTube ê²€ìƒ‰ í˜ì´ì§€ ë§í¬ ë²„íŠ¼ ì œê³µ
    # ê²€ìƒ‰ì–´: "<ì œëª©> trailer [ì—°ë„]"ë¥¼ URL ì¸ì½”ë”©í•˜ì—¬ ê²°ê³¼ í˜ì´ì§€ë¡œ ì—°ê²°
    q = urllib.parse.quote(f"{title} trailer {year or ''}")
    # ìµœì‹  Streamlitì€ link_button ì œê³µ. êµ¬ë²„ì „ì´ë©´ st.markdown("[ê²€ìƒ‰](URL)")ë¡œ ëŒ€ì²´ ê°€ëŠ¥.
    st.link_button("YouTubeì—ì„œ ì˜ˆê³ í¸ ê²€ìƒ‰", f"https://www.youtube.com/results?search_query={q}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# [ì°¸ê³ /ìš´ì˜ íŒ]
# - st.secrets ì„¤ì • ì˜ˆ:
#   .streamlit/secrets.toml íŒŒì¼ì—
#     YOUTUBE_API_KEY = "ì—¬ê¸°ì—_ë°œê¸‰ë°›ì€_API_í‚¤"
#   í˜•íƒœë¡œ ì €ì¥ (ë°°í¬ ì‹œì—ë„ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥)
# - ê³¼ê¸ˆ/ì¿¼í„°: YouTube Data APIëŠ” ì¼ì¼ ì¿¼í„°ê°€ ìˆìœ¼ë¯€ë¡œ ìºì‹œ(ttl)ë¡œ í˜¸ì¶œ ìˆ˜ë¥¼ ì¤„ì—¬ì•¼ í•œë‹¤.
# - ì§€ì—­/ì–¸ì–´: regionCode, ê²€ìƒ‰ì–´ì— 'official trailer' ë“±ì„ ì¶”ê°€í•´ë„ ì¢‹ë‹¤.
# - ì•ˆì „ì„±: ì™¸ë¶€ API ì‹¤íŒ¨ê°€ ì•± ì „ì²´ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ì˜ˆì™¸ëŠ” í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í–ˆë‹¤.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
