# ============================================
# UI: ì˜í™” ì¹´ë“œ(Grid) + ì•¡ì…˜ ë²„íŠ¼ 3ê°œ
# ============================================

def render_card_grid(items_df, key_prefix, n_cols=5, score_col=None):
    """
    ì˜í™” ì¹´ë“œ(í¬ìŠ¤í„°, ì œëª©, í‰ì )ì™€ ë²„íŠ¼(ìƒì„¸ë³´ê¸°Â·ì¦ê²¨ì°¾ê¸°Â·ê´€ì‹¬ì—†ìŒ)ì„
    ê·¸ë¦¬ë“œ í˜•íƒœë¡œ í‘œì‹œí•˜ëŠ” UI ë Œë”ë§ í•¨ìˆ˜.
    """

    if items_df is None or items_df.empty:
        st.info("í‘œì‹œí•  ì˜í™”ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    # -------------------------------
    # ì¹´ë“œ & ë²„íŠ¼ CSS ìŠ¤íƒ€ì¼
    # -------------------------------
    st.markdown(
        """
        <style>
        /* ì¹´ë“œ ì „ì²´ ë°•ìŠ¤ */
        .card-box {
            background: #111;
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            height: 100%;
        }
        .card-box:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
        }

        /* í¬ìŠ¤í„° ì´ë¯¸ì§€ */
        .poster-img {
            width: 100%;
            border-radius: 10px;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        /* ì˜í™” ì œëª© */
        .card-title {
            margin-top: 8px;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            text-align: center;
            height: 40px;
            overflow: hidden;
        }

        /* í‰ì  í‘œì‹œ */
        .card-meta {
            color: #ccc;
            font-size: 13px;
            text-align: center;
            margin-bottom: 6px;
        }

        /* ì¹´ë“œ í•˜ë‹¨ ë²„íŠ¼ ì™¸í˜• */
        .card-btn {
            background: #1f1f1f;
            border-radius: 16px;
            border: 1px solid #444;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        div.stButton > button:hover {
            border-color: #ffcc00;
        }
        </style>
        """,
        unsafe_allow_html=True,
    )

    # ì‚¬ìš©ì ë°ì´í„°
    user = st.session_state.get("auth_user")
    user_id = user["id"] if user else None
    favorites = get_favorites(user_id) if user_id else set()
    dismissed = get_dismissed(user_id) if user_id else set()

    # -------------------------------
    # ê·¸ë¦¬ë“œ í˜•íƒœ ì¹´ë“œ ë Œë”ë§
    # -------------------------------
    cols = st.columns(n_cols)

    for i, row in items_df.reset_index(drop=True).iterrows():
        with cols[i % n_cols]:
            mid = int(row["id"])
            poster = row.get("poster_url") or "https://via.placeholder.com/342x513"
            title = str(row["title"])
            vote = row.get("vote_average", "-")
            vote_str = f"{vote:.1f}" if isinstance(vote, (int, float)) else "-"

            score_extra = ""
            if score_col and score_col in row:
                try:
                    score_extra = f" Â· {float(row[score_col]):.3f}"
                except:
                    pass

            # -----------------------------
            # ì˜í™” ì¹´ë“œ HTML
            # -----------------------------
            st.markdown(
                f"""
                <div class="card-box">
                    <img src="{poster}" class="poster-img">
                    <div class="card-title">{title}</div>
                    <div class="card-meta">â­ {vote_str}{score_extra}</div>
                </div>
                """,
                unsafe_allow_html=True,
            )

            # -----------------------------
            # í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ 3ê°œ (ì •ë ¬ ì¤‘ì•™)
            # -----------------------------
            left, center, right = st.columns([1, 3, 1])
            with center:
                b1, b2, b3 = st.columns(3)

                # 1) ìƒì„¸ë³´ê¸° ë²„íŠ¼
                with b1:
                    if st.button("ğŸ”", key=f"{key_prefix}_detail_{i}"):
                        st.session_state["result"] = items_df
                        st.session_state["open_modal"] = True
                        st.session_state["detail_idx"] = i
                        st.rerun()

                # 2) ì¦ê²¨ì°¾ê¸° ë²„íŠ¼
                with b2:
                    if user_id:
                        is_fav = mid in favorites
                        fav_icon = "ğŸ’›" if is_fav else "â­"
                        if st.button(fav_icon, key=f"{key_prefix}_fav_{i}"):
                            toggle_favorite(user_id, mid)
                            st.rerun()
                    else:
                        st.button("â­", disabled=True)

                # 3) ê´€ì‹¬ì—†ìŒ ë²„íŠ¼
                with b3:
                    if user_id:
                        is_dis = mid in dismissed
                        icon = "â†©" if is_dis else "ğŸš«"
                        if st.button(icon, key=f"{key_prefix}_dis_{i}"):
                            if is_dis:
                                remove_dismissed(user_id, mid)
                            else:
                                add_dismissed(mid)
                            st.rerun()
                    else:
                        st.button("ğŸš«", disabled=True)
